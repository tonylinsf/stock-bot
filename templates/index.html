<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Stock Bot</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#0b1220; --card:#0f1b2e; --muted:#9fb0c7; --text:#eaf1ff;
      --border:rgba(255,255,255,.10); --good:#20c997; --bad:#ff6b6b; --chip:#1b2b45;
      --btn:#6f5bff;
    }
    body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;}
    .wrap{max-width:1100px;margin:0 auto;padding:18px;}
    .row{display:flex;gap:14px;flex-wrap:wrap;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 10px 25px rgba(0,0,0,.25);}
    .card h2,.card h3{margin:0 0 10px 0;}
    .muted{color:var(--muted);font-size:13px}
    .btn{background:var(--btn);border:none;color:white;padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .input{width:100%;padding:12px 12px;border-radius:10px;border:1px solid var(--border);background:#081021;color:var(--text)}
    .grid3{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
    }

    @media (max-width: 1100px){
      .grid3{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 700px){
      .grid3{ grid-template-columns: 1fr; }
    }

    /* è£œä½ç”¨ï¼šä½”ä½ä½†å””é¡¯ç¤º */
    .card.ghost{
      opacity:0;
      pointer-events:none;
    }
    @media(max-width:900px){.grid3{grid-template-columns:1fr}}
    .price{font-size:22px;font-weight:700}
    .chg.up{color:var(--good);font-weight:700}
    .chg.down{color:var(--bad);font-weight:700}
    .chip{display:inline-block;background:var(--chip);border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;margin:4px 6px 0 0}
    .pre{white-space:pre-wrap;word-wrap:break-word;background:#081021;border:1px solid var(--border);border-radius:12px;padding:12px;margin:10px 0}
    .sep{height:1px;background:var(--border);margin:14px 0}
    .badge-pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:600;}
    .badge-hot{background:rgba(255,77,79,.18);border:1px solid rgba(255,77,79,.35);}
    .badge-strong{background:rgba(82,196,26,.16);border:1px solid rgba(82,196,26,.35);}
    .badge-weak{background:rgba(250,173,20,.16);border:1px solid rgba(250,173,20,.35);}
    .badge-cold{background:rgba(24,144,255,.16);border:1px solid rgba(24,144,255,.35);}
    .badge-neutral{background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.18);}
    .grade{font-size:12px;padding:3px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.18);opacity:.95}
    .grade-a{background:rgba(82,196,26,.18)}
    .grade-b{background:rgba(255,255,255,.10)}
    .grade-c{background:rgba(255,77,79,.16)}
    .muted2{opacity:.85;font-size:12px;line-height:1.35}
    .badge {
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 12px;
    }

   .badge-hot { background:#7a1f1f; color:#ffb3b3; }
   .badge-strong { background:#14532d; color:#86efac; }
   .badge-weak { background:#1e3a8a; color:#93c5fd; }
   .badge-cold { background:#312e81; color:#c7d2fe; }

   .badge-grade {
     background:#334155;
     color:#e5e7eb;
    }

    .badge-support {
      background: #123f2d;
      color: #7CFFB2;
      border: 1px solid #2ecc71;
    }

    .badge-resist {
      background: #3a1a1a;
      color: #ff9c9c;
      border: 1px solid #e74c3c;
    }

    .badge-mid {
      background: #1f2937;
      color: #9ca3af;
      border: 1px solid #374151;
    }

    .rsi-low   { background:#3a1a1a; color:#ff9c9c; border:1px solid #e74c3c; }
    .rsi-weak  { background:#2b2a15; color:#ffd36a; border:1px solid #e0b34a; }
    .rsi-mid   { background:#1f2937; color:#9ca3af; border:1px solid #374151; }
    .rsi-strong{ background:#123f2d; color:#7cffb2; border:1px solid #2ecc71; }
    .rsi-high  { background:#2a1455; color:#c7b2ff; border:1px solid #8b5cf6; }

    .pill.up { background:#1f6f43; color:#b9ffd9; }
    .pill.down { background:#5a1e1e; color:#ffb3b3; }
    .pill.neutral { background:#333; color:#ddd; }
    .pill-buy { border:1px solid rgba(0,255,160,.35); }
    .pill-stop { border:1px solid rgba(255,90,90,.45); }
    .pill-res { border:1px solid rgba(255,200,0,.35); }

    /* RSI é¢œè‰²åˆ†çº§ */
    .rsi-low {
      background: rgba(46, 204, 113, 0.18);
      color: #2ecc71;
      border: 1px solid #2ecc71;
    }

    .rsi-weak {
      background: rgba(52, 152, 219, 0.18);
      color: #5dade2;
      border: 1px solid #5dade2;
    }

    .rsi-strong {
      background: rgba(241, 196, 15, 0.18);
      color: #f1c40f;
      border: 1px solid #f1c40f;
    }

    .rsi-high {
      background: rgba(231, 76, 60, 0.18);
      color: #e74c3c;
      border: 1px solid #e74c3c;
    }

    /* ===== å½©è‰² chips ===== */
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 13px;
      line-height: 1;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      white-space: nowrap;
    }

    /* MA / ä¸€èˆ¬æŒ‡æ¨™ï¼ˆè—è‰²ç³»ï¼‰ */
    .chip-ma {
      background: rgba(62, 152, 255, .18);
      border-color: rgba(62, 152, 255, .35);
      color: #bfe0ff;
    }

    /* RSI é¡è‰²ï¼ˆè·Ÿä½ æƒ³è¦çš„ï¼šè¶…è²·ç´…ã€æ¥è¿‘è¶…è²·é»ƒã€ä¸­æ€§ç°/è—ã€åå¼±åé’ã€è¶…è³£ç¶ ï¼‰ */
    .chip-rsi-low {   /* <=30 è¶…è³£ */
      background: rgba(46, 204, 113, .18);
      border-color: rgba(46, 204, 113, .35);
      color: #bff7d0;
    }
    .chip-rsi-weak {  /* 30~45 åå¼± */
      background: rgba(0, 206, 201, .16);
      border-color: rgba(0, 206, 201, .32);
      color: #bffaf7;
    }
    .chip-rsi-mid {   /* 45~60 ä¸­æ€§ */
      background: rgba(170, 180, 200, .14);
      border-color: rgba(170, 180, 200, .28);
      color: #e7ecf6;
    }
    .chip-rsi-strong {/* 60~70 åå¼·ï¼ˆé»ƒè‰²ï¼‰ */
      background: rgba(255, 193, 7, .18);
      border-color: rgba(255, 193, 7, .35);
      color: #ffe7a8;
    }
    .chip-rsi-high {  /* >=70 è¶…è²·ï¼ˆç´…è‰²ï¼‰ */
      background: rgba(255, 77, 79, .18);
      border-color: rgba(255, 77, 79, .38);
      color: #ffd0d0;
    }

    /* ===== è¶¨å‹¢åˆ†æ•¸ bar ===== */
    .score-wrap{
      margin-top: 10px;
    }
    .score-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color: rgba(255,255,255,.8);
      font-size: 13px;
    }
    .score-num{
      font-size: 20px;
      font-weight: 800;
      color: rgba(255,255,255,.95);
    }
    .score-bar{
      margin-top: 8px;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      overflow: hidden;
      border: 1px solid rgba(255,255,255,.06);
    }
    .score-fill{
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, #2ecc71 0%, #f1c40f 55%, #ff4d4f 100%);
    }

    /* âœ… é˜²æ­¢æ•´é æ©«å‘çˆ†å‡ºå» */
    html, body { overflow-x: hidden; }

    /* âœ… å¡ç‰‡å…§ä»»ä½•æ–‡å­—éƒ½è¦è­˜æ›è¡Œ */
    .card, .muted, .muted2, .ai-box, .ai-summary, .ai-advice {
      word-break: break-word;
      overflow-wrap: anywhere;
      white-space: normal;
    }

    /* âœ… å¦‚æœä½  AI å…§å®¹ä¿‚ç”¨ <pre> æˆ– code é¡¯ç¤ºï¼Œå’è¦ç‰¹åˆ¥è™•ç† */
    pre, code {
      white-space: pre-wrap;
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    /* âœ… åœ–è¡¨/å…§å®¹å””å¥½è¶…å‡ºå¡ç‰‡ */
    .card { overflow: hidden; }
    canvas { max-width: 100% !important; height: auto !important; display:block; }

    /* âœ… iPhone / æ‰‹æ©Ÿï¼šé˜²æ©«å‘çˆ†ç‰ˆ */
    html, body { max-width: 100%; overflow-x: hidden; }
    * { box-sizing: border-box; }

    /* âœ… å¤–æ¡†åŒå¡ç‰‡å””å¥½ç¡¬æ€§å¯¬åº¦ */
    .wrap { width: 100%; max-width: 100%; padding: 14px; }
    .card { width: 100%; max-width: 100%; overflow: hidden; }

    /* âœ… æ‰€æœ‰æ–‡å­—éƒ½å…è¨±æ–·è¡Œï¼ˆå°¤å…¶ AI å…§å®¹ï¼‰ */
    .card, .muted, .muted2, .ai, .ai-box, .ai-summary, .ai-advice {
      white-space: normal;
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    /* âœ… chip / badge æœƒå¥½å¤šå­—ï¼šè¦å¯ä»¥æ›è¡Œï¼‹å””å¥½è¶…å‡º */
    .chips, .badges, .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .chip, .badge {
      max-width: 100%;
      white-space: normal;
      overflow-wrap: anywhere;
    }

    /* âœ… åœ–è¡¨/canvas ä¸€å®šè¦è·Ÿå®¹å™¨ç¸®æ”¾ */
    canvas { max-width: 100% !important; height: auto !important; display: block; }

    /* âœ… æ‰‹æ©Ÿï¼šä¸‰æ ¼è®Šä¸€æ ¼ï¼Œé¿å… grid æ’çˆ† */
    @media (max-width: 640px) {
      .grid3 { grid-template-columns: 1fr !important; }
    }

    html, body {
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
      overscroll-behavior: none;
    }

    input, textarea {
      font-size: 16px !important;
    }

    input[type="text"], input[type="search"] {
      height: 44px;
      line-height: 44px;
      padding: 0 12px;
    }

    /* ğŸ”½ æ‰‹æ©Ÿ loading CSS å°±åŠ å–ºå‘¢åº¦æœ€åº• */
    @media (hover: none) and (pointer: coarse) {
      #mLoading {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,.45);
        backdrop-filter: blur(2px);
        z-index: 9999;
        display: none;
      }
      .mLoading-box {
        position:absolute;
        left:50%;
        top:18%;
        transform:translateX(-50%);
        background: rgba(15,20,35,.92);
        border-radius:14px;
        padding:14px 16px;
        display:flex;
        gap:12px;
        align-items:center;
      }
      .mSpinner {
        width:18px;height:18px;
        border-radius:50%;
        border:3px solid rgba(255,255,255,.25);
        border-top-color:#fff;
        animation:mspin .7s linear infinite;
      }
      @keyframes mspin { to { transform: rotate(360deg); } }
    }

    .btn.loading { opacity: .75; pointer-events: none; }
    .spinner{
      width:14px;height:14px;border-radius:50%;
      border:2px solid rgba(255,255,255,.35);
      border-top-color:#fff;
      display:inline-block;
      animation: spin .8s linear infinite;
      vertical-align: -2px;
      margin-right:8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .status-line{padding:10px 12px;border-radius:10px;margin-top:10px;border:1px solid rgba(255,255,255,.10);font-weight:700}
    .status-good{background:rgba(34,197,94,.10);color:#bbf7d0}
    .status-mid{background:rgba(234,179,8,.08);color:#fde68a}
    .status-bad{background:rgba(239,68,68,.10);color:#fecaca}

    .level-card{margin-top:10px;padding:10px 12px;border-radius:10px;background:#0b1220;border:1px solid rgba(255,255,255,.08);display:grid;gap:6px}

    /* ====== Market Tapeï¼ˆè·‘é¦¬ç‡ˆï¼‰ ====== */
    .tape{
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(11,18,32,.92);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
      margin-bottom: 12px;
      overflow: hidden;
      backdrop-filter: blur(8px);
    }
    .tape-track{
      display: inline-flex;
      align-items: center;
      gap: 10px;
      white-space: nowrap;
      animation: tapeMove 24s linear infinite;
    }
    .tape:hover .tape-track{ animation-play-state: paused; }

    @keyframes tapeMove{
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }

    .tape-item{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      font-size: 13px;
    }
    .tape-sym{ font-weight: 800; letter-spacing:.2px; }
    .tape-val{ opacity: .92; }

    .tape-chg.up{ color: var(--good); font-weight: 800; }
    .tape-chg.down{ color: var(--bad); font-weight: 800; }
    .tape-chg.neutral{ color: rgba(255,255,255,.75); font-weight: 700; }

    .tape-note{ opacity:.75; font-size:12px; margin-left:6px; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
    }

    .fg-badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      font-size:13px; font-weight:700;
      border:1px solid rgba(255,255,255,.12);
    }
    .sig-good    { background: rgba( 46, 204, 113, .15); color: #7CFFB2; }
    .sig-warn    { background: rgba(241, 196, 15, .15);  color: #FFE08A; }
    .sig-neutral { background: rgba(189, 195, 199, .15); color: #E2E6EA; }
    .sig-hot     { background: rgba(230, 126, 34, .15);  color: #FFC59B; }
    .sig-danger  { background: rgba(231, 76, 60,  .15);  color: #FF9B9B; }

    .fg-hint { font-size:12px; opacity:.8; margin-top:6px; line-height:1.5; }
  </style>
</head>
<body>
<div class="wrap">
  
  <!-- âœ… Market Tape -->
  {% if tape %}
  <div class="tape">
    {# åšå…©ä»½ä¸€æ¨£å˜… trackï¼Œå…ˆå¯ä»¥ç„¡ç¸«å¾ªç’° #}
    <div class="tape-track">
      {% for _ in range(2) %}
        {% set spy = tape.get('SPY', {}) %}
        {% set qqq = tape.get('QQQ', {}) %}
        {% set vix = tape.get('VIX', {}) %}
        {% set tnx = tape.get('TNX', {}) %}

        <!-- SPY -->
        <span class="tape-item">
          <span class="tape-sym">SPY</span>
          <span class="tape-val">
            {% if spy.price is not none %}${{ "%.2f"|format(spy.price) }}{% else %}--{% endif %}
          </span>
          {% set c = spy.chg_pct %}
          <span class="tape-chg {% if c is not none and c>0 %}up{% elif c is not none and c<0 %}down{% else %}neutral{% endif %}">
            {% if c is not none %}{{ "%.2f"|format(c) }}%{% else %}--{% endif %}
          </span>
        </span>

        <!-- QQQ -->
        <span class="tape-item">
          <span class="tape-sym">QQQ</span>
          <span class="tape-val">
            {% if qqq.price is not none %}${{ "%.2f"|format(qqq.price) }}{% else %}--{% endif %}
          </span>
          {% set c = qqq.chg_pct %}
          <span class="tape-chg {% if c is not none and c>0 %}up{% elif c is not none and c<0 %}down{% else %}neutral{% endif %}">
            {% if c is not none %}{{ "%.2f"|format(c) }}%{% else %}--{% endif %}
          </span>
        </span>

        <!-- VIX -->
        <span class="tape-item">
          <span class="tape-sym">VIX</span>
          <span class="tape-val">
            {% if vix.price is not none %}{{ "%.2f"|format(vix.price) }}{% else %}--{% endif %}
          </span>
          {% set c = vix.chg_pct %}
          <span class="tape-chg {% if c is not none and c>0 %}up{% elif c is not none and c<0 %}down{% else %}neutral{% endif %}">
            {% if c is not none %}{{ "%.2f"|format(c) }}%{% else %}--{% endif %}
          </span>
          {% if vix.price is not none and vix.price > 20 %}
            <span class="tape-note">âš ï¸ æ³¢å‹•åå¤§</span>
          {% endif %}
        </span>

        <!-- TNX (10Y) -->
        <span class="tape-item">
          <span class="tape-sym">10Y</span>
          <span class="tape-val">
            {% if tnx.yield_pct is not none %}{{ "%.2f"|format(tnx.yield_pct) }}%{% else %}--{% endif %}
          </span>
          {% set c = tnx.chg_pct %}
          <span class="tape-chg {% if c is not none and c>0 %}up{% elif c is not none and c<0 %}down{% else %}neutral{% endif %}">
            {% if c is not none %}{{ "%.2f"|format(c) }}%{% else %}--{% endif %}
          </span>
        </span>

      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- ğŸ”” åŠŸèƒ½å…¥å£ -->
  <div class="card" style="padding:10px 12px;">
    <a class="tag" href="/daily-picks" onclick="showLoading('æ­£åœ¨ç”Ÿæˆæ¯æ—¥æ¨èâ€¦','Generating Daily Picksâ€¦')">ğŸ“Œ æ¯æ—¥æ¨è</a>
  </div>


  <!-- Single stock -->
  <div class="card">
    <h2>ğŸ” å€‹è‚¡åˆ†æï¼ˆæŠ€è¡“æŒ‡æ¨™ï¼‰</h2>

    <form method="POST" action="/" style="margin-top:10px">
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <input class="input" name="ticker" placeholder="è¼¸å…¥ä»£è™Ÿï¼Œä¾‹å¦‚ NVDA / AAPL / TSLA / QQQ" value="{{ ticker }}" style="flex:1;min-width:220px">
        <button class="btn" id="analyzeBtn" type="submit">åˆ†æ</button>
      </div>
    </form>

    {% if error %}
      <div class="sep"></div>
      <div class="muted">âŒ {{ error }}</div>
    {% endif %}

    {% if request.method == "POST" and indicators.get("last_price") is not none %}
      <div class="sep"></div>

      <h3 style="margin:0 0 8px 0">{{ indicators.ticker }}ã€€${{ indicators.last_price }}ã€€
        {% if indicators.change_pct is not none %}
          {% if indicators.change_pct >= 0 %}
            <span class="chg up">â–² {{ indicators.change_pct }}%</span>
          {% else %}
            <span class="chg down">â–¼ {{ indicators.change_pct }}%</span>
          {% endif %}
        {% endif %}
      </h3>
      <div class="muted">æ”¶å¸‚æ—¥ï¼š{{ indicators.last_date }}ï½œè¶¨å‹¢åˆ†æ•¸ï¼š{{ indicators.trend_score }}</div>

      <div class="score-wrap">
        <div class="score-row">
          <div>è¶¨å‹¢åˆ†æ•¸ï¼ˆ0â€“100ï¼‰ï¼š</div>
          <div class="score-num">{{ indicators.trend_score }}/100</div>
       </div>
       <div class="score-bar">
         <div class="score-fill" style="width: {{ indicators.trend_score or 0 }}%"></div>
       </div>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        {% if indicators.rsi is not none %}
          <span class="chip {{ indicators.rsi_class }}">
            RSI14 {{ indicators.rsi }}
            {% if indicators.rsi_label %}<span style="opacity:.85">ï¼ˆ{{ indicators.rsi_label.split(' ')[-1] }}ï¼‰</span>{% endif %}
          </span>
        {% endif %}
        <span class="chip">MA5 {{ indicators.ma5 }}</span>
        <span class="chip">MA20 {{ indicators.ma20 }}</span>
        <span class="chip">MA60 {{ indicators.ma60 }}</span>
        <span class="chip">MACD {{ indicators.macd }}</span>
        <span class="chip">BOLL {{ indicators.boll_lower }} ~ {{ indicators.boll_upper }}</span>
        <span class="chip">é‡ {{ indicators.volume_str }}ï¼ˆ20æ—¥å‡ {{ indicators.avg20_volume_str }}ï¼‰</span>
      </div>
      {% if indicators.high_52w and indicators.low_52w %}
        <span class="chip">
          52å‘¨ {{ indicators.low_52w }} â€“ {{ indicators.high_52w }}
          ï½œ è·é«˜ä½ 
        <span style="color:{% if indicators.from_high_pct < 0 %}#ff6b6b{% else %}#4cd964{% endif %}">
          {{ "%.2f"|format(indicators.from_high_pct) }}%
        </span>
      </span>
      {% endif %}

      {% set ws = indicators.get('week_support') %}
      {% set wr = indicators.get('week_resistance') %}
      {% set wm = indicators.get('week_mid') %}

      {% if ws is not none or wr is not none or wm is not none %}
        <div class="level-card">
          <div>1å‘¨æ”¯æŒ <b>{{ ws if ws is not none else "-" }}</b></div>
          <div>1å‘¨ä¸­ <b>{{ wm if wm is not none else "-" }}</b></div>
          <div>1å‘¨é˜»åŠ› <b>{{ wr if wr is not none else "-" }}</b></div>
        </div>
      {% endif %}

      {% if indicators.st_buy_low or indicators.st_buy_high %}
        <div class="sep"></div>

        <div class="level-card" style="border-left:4px solid #22c55e">
          <div><b>ğŸ“Œ çŸ­çº¿ä¹°å–è®¡åˆ’</b></div>

          {% if indicators.st_buy_low and indicators.st_buy_high %}
            <div>ğŸŸ¢ ä¹°å…¥åŒºé—´ï¼š
              <b>{{ indicators.st_buy_low }} â€“ {{ indicators.st_buy_high }}</b>
            </div>
          {% endif %}

          {% if indicators.st_stop %}
            <div>ğŸ”´ æ­¢æŸä½ï¼š
              <b>{{ indicators.st_stop }}</b>
            </div>
          {% endif %}

          {% if indicators.st_resistance %}
            <div>ğŸŸ¡ ä¸Šæ–¹å‹åŠ›ï¼š
              <b>{{ indicators.st_resistance }}</b>
            </div>
          {% endif %}

          {% if supports %}
          <div style="margin-top:12px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.08);">
            <div style="color:#9aa4b2; font-size:13px; margin-bottom:6px;">ğŸ“‰ ä¸­çº¿åˆ†æ‰¹æ”¯æ’‘ä½</div>

            {% if supports.support_60 %}
            <div>ğŸŸ¡ ç¬¬äºŒä¹°å…¥ä½ï¼ˆ60æ—¥æ”¯æ’‘ï¼‰ï¼š 
              <b>{{ "%.2f"|format(supports.support_60) }}</b>
            </div>
            {% endif %}

            {% if supports.support_120 %}
            <div>ğŸŸ  ç¬¬ä¸‰ä¹°å…¥ä½ï¼ˆ120æ—¥æ”¯æ’‘ï¼‰ï¼š 
              <b>{{ "%.2f"|format(supports.support_120) }}</b>
            </div>
            {% endif %}

            {% if supports.support_365 %}
            <div>ğŸ”´ ç¬¬å››ä¹°å…¥ä½ï¼ˆ365æ—¥æ”¯æ’‘ï¼‰ï¼š 
              <b>{{ "%.2f"|format(supports.support_365) }}</b>
            </div>
            {% endif %}
          </div>
        {% endif %}

        </div>  {# âœ… level-card ç»“æŸ #}
      {% endif %} {# âœ… æœ€å¤–å±‚ if ç»“æŸ #}

      <div class="card">
        <h3>ä¼°å€¼å€é–“</h3>

        {# å„ªå…ˆç”¨ route å‚³å…¥ valuationï¼Œå…¶æ¬¡ indicators å…¥é¢ valuation #}
        {% set v = valuation if valuation else indicators.get('valuation') %}
        {% set f = indicators.get('fundamentals') %}
        {% set extra = (v.get('extra') if v and v.get('extra') else {}) %}

        {% if v %}

          {# 1) fair value range #}
          {% if v.get('fair_low') is not none and v.get('fair_high') is not none %}
            <div class="big">
              ${{ "%.2f"|format(v.get('fair_low')) }} â€“ ${{ "%.2f"|format(v.get('fair_high')) }}
            </div>
          {% endif %}

          {# 2) å¸‚å ´æƒ…ç·’ä¼°å€¼ï¼ˆä½ å¾Œç«¯ key ä¿‚ mkt_low/mkt_high/mkt_tagï¼‰ #}
          {% set mk = v.get('market') %}
          {% if mk %}
            {% set mk_low  = mk.get('low',  mk.get('mkt_low')) %}
            {% set mk_high = mk.get('high', mk.get('mkt_high')) %}
            {% set mk_tag  = mk.get('tag',  mk.get('mkt_tag')) %}
            {% set mk_gap  = mk.get('gap_pct', mk.get('mkt_gap_pct')) %}

            {% if mk_low is not none and mk_high is not none %}
              <div style="margin-top:8px;">
                <span class="muted">å¸‚å ´æƒ…ç·’ä¼°å€¼ï¼š</span>
                <span class="big">
                  ${{ "%.2f"|format(mk_low) }} â€“ ${{ "%.2f"|format(mk_high) }}
                </span>
                {% if mk_tag %}<span class="pill">{{ mk_tag }}</span>{% endif %}
              </div>

              {% if mk_gap is not none %}
                <div class="muted">å¸‚å ´åé›¢ï¼š{{ "%.1f"|format(mk_gap) }}%</div>
              {% endif %}
            {% endif %}
          {% endif %}

          {# 3) gap pct #}
          {% if v.get('gap_pct') is not none %}
            <div class="muted">åé›¢ï¼š{{ "%.1f"|format(v.get('gap_pct')) }}%</div>
          {% endif %}

          {# 4) PE range #}
          {% if v.get('pe_low') is not none and v.get('pe_high') is not none %}
            <div class="muted">PE å‡è¨­ï¼š{{ v.get('pe_low')|round(0)|int }} â€“ {{ v.get('pe_high')|round(0)|int }}</div>
          {% endif %}

          {# 5) Forward PE rangeï¼ˆå¦‚æœä½ å¾Œç«¯æœ‰ fwd_pe_low/highï¼‰ #}
          {% if v.get('fwd_pe_low') is not none and v.get('fwd_pe_high') is not none %}
            <div class="muted">Forward PEï¼š{{ v.get('fwd_pe_low')|round(0)|int }} â€“ {{ v.get('fwd_pe_high')|round(0)|int }}</div>
          {% endif %}

          {# 6) PS rangeï¼ˆå¦‚æœä½ å¾Œç«¯æœ‰ ps_low/highï¼‰ #}
          {% if v.get('ps_low') is not none and v.get('ps_high') is not none %}
            <div class="muted">PS å‡è¨­ï¼š{{ "%.1f"|format(v.get('ps_low')) }} â€“ {{ "%.1f"|format(v.get('ps_high')) }}</div>
          {% endif %}

          {# 7) extra æŒ‡æ¨™ï¼ˆä½ è€Œå®¶ screenshot æƒ³è¦å—°å †ï¼‰ #}
          {% if extra %}

          {% if extra.get('forward_pe') is not none %}
            <div class="muted">Forward PEï¼š{{ "%.1f"|format(extra.get('forward_pe')) }}</div>
          {% endif %}

          {% if extra.get('peg') is not none %}
            <div class="muted">
              PEGï¼š{{ "%.2f"|format(extra.get('peg')) }}
              {% if extra.get('growth_earnings') is not none %}
               ï¼ˆEarnings Growth {{ "%.0f"|format(extra.get('growth_earnings')) }}%ï¼‰
              {% endif %}
            </div>
          {% endif %}

          {% if extra.get('fcf_yield') is not none %}
            <div class="muted">FCF Yieldï¼š{{ "%.1f"|format(extra.get('fcf_yield')) }}%</div>
          {% endif %}

          {% if extra.get('ev_sales') is not none %}
            <div class="muted">EV/Salesï¼š{{ "%.1f"|format(extra.get('ev_sales')) }}</div>
          {% endif %}

          {% if extra.get('pb') is not none or extra.get('roe') is not none %}
            <div class="muted">
              PBï¼š{{ "%.1f"|format(extra.get('pb')) if extra.get('pb') is not none else "--" }}
              | ROEï¼š{{ "%.0f"|format(extra.get('roe')) if extra.get('roe') is not none else "--" }}%
            </div>
          {% endif %}

          {% endif %}

          {# å¦‚æœ v æœ‰ï¼Œä½† fair_low/high å†‡ï¼ˆæœ‰æ™‚ fundamentals æ‹å””åˆ°ï¼‰å°±æç¤º #}
          {% if v.get('fair_low') is none or v.get('fair_high') is none %}
            <div class="muted" style="margin-top:8px;">
              å·²å–å¾—åŸºæœ¬é¢è³‡æ–™ï¼Œä½†ä¼°å€¼æœªèƒ½è¨ˆç®—ï¼ˆå¸¸è¦‹ï¼šEPS / Forward EPS / RevenueShare å–å¾—ä¸åˆ°æˆ– <= 0ï¼‰
            </div>
            {% if f %}
              <div class="muted">Priceï¼š{{ f.get('price', '-') }}</div>
              <div class="muted">EPS(TTM)ï¼š{{ f.get('eps_ttm', '-') }}</div>
              <div class="muted">PE(TTM)ï¼š{{ f.get('pe_ttm', '-') }}</div>
              <div class="muted">Forward EPSï¼š{{ f.get('forward_eps', '-') }}</div>
              <div class="muted">Forward PEï¼š{{ f.get('forward_pe', '-') }}</div>
              <div class="muted">RPS(TTM)ï¼š{{ f.get('revenue_per_share_ttm', '-') }}</div>
              <div class="muted">PS(TTM)ï¼š{{ f.get('ps_ttm', '-') }}</div>
            {% endif %}
          {% endif %}

        {% else %}
          <div class="muted">æœªæœ‰ä¼°å€¼è³‡æ–™ï¼šè«‹å…ˆæäº¤åˆ†æã€‚</div>
        {% endif %}
      </div>

      {% if indicators.tech_signals %}
        <div style="margin-top:10px">
          {% for s in indicators.tech_signals %}
            <span class="chip">{{ s.label }}</span>
          {% endfor %}
        </div>
      {% endif %}   
      <div>
    {% endif %}
  </div>

  {% if insider_trades %}
  <div class="card">
    <h3>ğŸ•µï¸ å…§éƒ¨äººäº¤æ˜“ï¼ˆYahoo Financeï¼‰</h3>
    {% for t in insider_trades %}
      <p>
        {{ t.date }} - {{ t.name }} {% if t.relation %} ({{ t.relation }}) {% endif %}
        <b style="color: {{ 'lime' if t.type == 'Buy' else 'red' }}">
          {{ t.type }}
        </b>
        {% if t.shares %}
          {{ "{:,}".format(t.shares) }} è‚¡
        {% else %}
          -
        {% endif %}
      </p>
    {% endfor %}
  </div>
  {% else %}
  <div class="card">
    <h3>ğŸ•µï¸ å…§éƒ¨äººäº¤æ˜“</h3>
    <p>æš«ç„¡å…¬é–‹å…§éƒ¨äººäº¤æ˜“è¨˜éŒ„</p>
  </div>
  {% endif %}

  {% if moat %}
    <h3>{{ moat.title }}</h3>
    <div class="muted">{{ moat.summary }}</div>

    {% if moat.rows %}
      <div style="margin-top:12px;">
        {% for r in moat.rows %}
          <div>{{ r.label }}ï¼š<b>{{ r.value }}</b></div>
        {% endfor %}
      </div>
    {% else %}
      <div class="muted" style="margin-top:10px;">
       ï¼ˆæœªè¿”å›å¯æ˜¾ç¤ºçš„æœºæ„å˜åŠ¨è¡Œï¼‰
      </div>
    {% endif %}

    <div class="muted" style="margin-top:8px;font-size:12px;">
      {{ moat.note }}
    </div>

  {% else %}
    <form method="POST" style="margin-top:10px;">
      <input type="hidden" name="ticker" value="{{ ticker }}">
      <input type="hidden" name="load_13f" value="1">
      <button class="btn" type="submit">æŸ¥çœ‹æœºæ„æŒä»“åŠ¨å‘ï¼ˆSEC 13Fï¼‰</button>
    </form>

    {% if load_13f_flag %}
      <div class="muted" style="margin-top:10px;">
        å·²æäº¤æŸ¥è¯¢ï¼Œä½†åç«¯æœªè¿”å› moatï¼ˆè¯·çœ‹ç»ˆç«¯ DEBUG form / DEBUG moatï¼‰ã€‚
      </div>
    {% endif %}
  {% endif %}

  <!-- Market Overview -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <div>
        <h2>ğŸ“Œ ä»Šæ—¥å¸‚å ´æ¦‚è¦½ï¼ˆSPY / QQQ / DIAï¼‰</h2>
        <div class="muted">æç¤ºï¼šå¦‚è¦‹åˆ°æ•¸æ“šèˆŠï¼ŒæŒ‰å³é‚Šã€Œæ‰‹å‹•æ›´æ–°ã€</div>
      </div>
      <form method="POST" action="/refresh_market" style="margin:0">
        <button id="refreshBtn" class="btn" type="submit">æ‰‹å‹•æ›´æ–°ä»Šæ—¥å¸‚å ´</button>
      </form>
    </div>

    <div class="sep"></div>

    <!-- âœ… å…ˆæ”¾ã€Œå¸‚å ´è„ˆæã€å¡ï¼ˆå””å…¥ grid3ï¼‰ -->
    <div class="card" style="margin-top:12px;">
      <h3>ğŸ“ å¸‚å ´è„ˆæï¼ˆFear&Greed + ä»Šæ—¥ç¸½ç‡ˆè™Ÿï¼‰</h3>

      <div id="pulseTop" style="font-size:16px; margin:6px 0;">è®€å–ä¸­...</div>
      <div id="pulseBadges" style="display:flex; gap:10px; flex-wrap:wrap; margin-top:8px;"></div>
      <div id="pulseHint" class="fg-hint"></div>

      <div style="font-size:13px; opacity:.85; line-height:1.6; margin-top:8px;">
        <div id="pulseDetail"></div>
        <div id="pulseUpdated" style="opacity:.7;"></div>
      </div>
    </div>

    <!-- âœ… å†é–‹ä¸€å€‹ grid3ï¼Œåªæ”¾ ticker å¡ -->
    <div class="grid3">
      {% for m in market_overview %}
        <div class="card" style="padding:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3 style="margin:0">{{ m.ticker_display or m.ticker }}</h3>
            <div class="muted">æ›´æ–°ï¼š{{ m.updated_date if m.updated_date else "-" }}</div>
          </div>

          {% if m.error %}
            <div class="muted">Error: {{ m.error }}</div>
          {% else %}
            <div style="display:flex;align-items:baseline;gap:10px;margin-top:6px">
              <div class="price">${{ '%.2f'|format(m.last_price) }}</div>
              {% if m.change_pct is not none %}
                {% if m.change_pct >= 0 %}
                  <div class="chg up">â–² {{ '%.2f'|format(m.change_pct) }}%</div>
                {% else %}
                  <div class="chg down">â–¼ {{ '%.2f'|format(m.change_pct) }}%</div>
                {% endif %}
              {% endif %}
            </div>

            <div class="muted" style="margin-top:8px">
              RSI14ï¼š{{ m.rsi14 if m.rsi14 is not none else "-" }}ã€€
              MA20ï¼š{{ m.ma20 if m.ma20 is not none else "-" }}ã€€
              MA60ï¼š{{ m.ma60 if m.ma60 is not none else "-" }}
            </div>

            {% if m.week_support and m.week_resistance %}
            <div class="mini-row">
              <span class="pill neutral">
                å‘¨æ”¯æ’‘ {{ "%.2f"|format(m.week_support) }}
              </span>
              <span class="pill neutral">
                å‘¨å‹åŠ› {{ "%.2f"|format(m.week_resistance) }}
              </span>
            </div>
            {% endif %}

            {% set dts = m.get('dist_to_support') %}
            {% if dts is not none %}
              <span class="pill up">
                è·æ”¯æ’‘ {{ "%.2f"|format(dts) }}%
              </span>
            {% endif %}

            {% set dtr = m.get('dist_to_resistance') %}
            {% if dtr is not none %}
              <span class="pill down">
                è·å‹åŠ› {{ "%.2f"|format(dtr) }}%
              </span>
            {% endif %}
                
            {% if m.status_text %}
            <div class="muted" style="margin-top:6px;">
              <span class="pill {{ m.status_class }}">
                {{ m.status_text }}
              </span>
            </div>
            {% endif %} 

            {% if m.trend_pct is not none %}
            <div class="muted" style="margin-top:6px;">
              {{ m.trend_days }}æ—¥è¶‹åŠ¿ï¼š
              {% if m.trend_dir == "up" %}
                <span style="color:#4ade80">â†‘ {{ "%.2f"|format(m.trend_pct) }}%</span>
              {% elif m.trend_dir == "down" %}
                <span style="color:#f87171">â†“ {{ "%.2f"|format(m.trend_pct) }}%</span>
              {% else %}
                <span style="color:#a3a3a3">â†’ {{ "%.2f"|format(m.trend_pct) }}%</span>
              {% endif %}
            </div>
            {% endif %}

            {% if m.ma_cross %}
            <div class="muted" style="margin-top:4px">
              {% if m.ma_cross == "golden" %}
                <span style="color:#facc15">âœ¨ é‡‘å‰ï¼ˆMA20 â†‘ MA60ï¼‰</span>
              {% elif m.ma_cross == "death" %}
                <span style="color:#fb7185">âš ï¸ æ­»å‰ï¼ˆMA20 â†“ MA60ï¼‰</span>
              {% endif %}
            </div>
            {% endif %}

            <div class="muted" style="margin-top:6px">
              è·é›¢ MA60ï¼š{{ m.dist_ma60 if m.dist_ma60 is not none else "-" }}%ã€€
              52é€±ï¼š{{ m.low_52w if m.low_52w is not none else "-" }} ~ {{ m.high_52w if m.high_52w is not none else "-" }}ã€€
              è·é«˜ä½ï¼š{{ m.from_high_pct if m.from_high_pct is not none else "-" }}%
            </div>

            {% if m.sr_text %}
            <div class="muted" style="margin-top:6px">
              ğŸ“ {{ m.sr_text }}
            </div>
            {% endif %}

            {% if m.key_status %}
            <div class="muted" style="margin-bottom:6px">
              ğŸ“Œ ä»Šæ—¥å…³é”®çŠ¶æ€ï¼š{{ m.key_status }}
            </div>
            {% endif %}

            {% if m.support20 and m.resist20 %}
            <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap">

              {% if m.sr_zone == "support" %}
                <span class="badge badge-support">
                  é è¿‘æ”¯æ’‘ ({{ m.dist_support_pct }}%)
                </span>
              {% elif m.sr_zone == "resist" %}
                <span class="badge badge-resist">
                  æ¥è¿‘é˜»åŠ› ({{ m.dist_resist_pct }}%)
                </span>
              {% else %}
                <span class="badge badge-mid">
                  åŒºé—´ä¸­éƒ¨
                </span>
              {% endif %}

            </div>
            {% endif %}

            {% if m.weekly_text %}
              <div class="muted" style="margin-top:6px">é€±ç·šæ¦‚æ³ï¼š{{ m.weekly_text }}</div>
            {% endif %}

            {% if m.support20 and m.resist20 %}
              <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap">
                {% if m.sr_zone == "support" %}
                  <span class="badge badge-support">ğŸŸ¢ æ¥è¿‘æ”¯æ’ ({{ m.dist_support_pct }}%)</span>
                {% elif m.sr_zone == "resist" %}
                  <span class="badge badge-resist">ğŸ”´ æ¥è¿‘é˜»åŠ› ({{ m.dist_resist_pct }}%)</span>
                {% else %}
                  <span class="badge badge-mid">âšª å€é–“ä¸­æ®µ</span>
                {% endif %}
              </div>
            {% endif %}

            <div class="muted" style="margin-top:6px">
              æ”¯æ’‘/é˜»åŠ›(90æ—¥)ï¼š{{ m.support90 if m.support90 is not none else "--" }} ~ {{ m.resist90 if m.resist90 is not none else "--" }}
            </div>

            <div class="muted" style="margin-top:6px">
              æ³¢å‹•(ATR14%)ï¼š{{ (m.atr_pct|string + "%") if m.atr_pct is not none else "--" }}
            </div>

            {% if m.ticker != "SPY" and (m.rs_1m is not none or m.rs_3m is not none) %}
              <div class="muted" style="margin-top:6px">
                ç›¸å°SPYï¼š1M {{ m.rs_1m if m.rs_1m is not none else "--" }}%
                ï¼3M {{ m.rs_3m if m.rs_3m is not none else "--" }}%
              </div>
            {% endif %}

            <!-- ğŸ”¥ RSI ç‹€æ…‹ + å¸‚å ´è©•ç´š -->
           <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">

             {% if m.rsi14 is not none %}
               <span class="chip {{ m.rsi_class }}">RSI14 {{ "%.2f"|format(m.rsi14) }}</span>
             {% endif %}
             {% if m.ma20 is not none %}<span class="chip chip-ma">MA20 {{ m.ma20 }}</span>{% endif %}
             {% if m.ma60 is not none %}<span class="chip chip-ma">MA60 {{ m.ma60 }}</span>{% endif %}

             {% if m.grade %}
                  <span class="badge badge-grade">
                    è©•ç´š {{ m.grade }}
                  </span>
             {% endif %}

           </div>

           {% if m.conclusion %}
             <div class="muted" style="margin-top:6px">
               {{ m.conclusion }}
             </div>
           {% endif %}

            <div style="margin-top:8px">
              {% for s in m.signals %}
                <span class="chip">{{ s }}</span>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      {% endfor %}

      {% set n = market_overview|length %}
      {% if n % 3 != 0 %}
        {% for _ in range(3 - (n % 3)) %}
          <div class="card" style="padding:12px; opacity:.15; border-style:dashed;">
            <div class="muted"> </div>
          </div>
        {% endfor %}
      {% endif %}
    </div>
  </div>

  <div style="height:14px"></div>

</div>
<!-- âœ… å¿…åšâ‘¡ï¼šé” scroll JSï¼ˆæ”¾è¿™é‡Œï¼‰ -->
<script>
  const lockScroll = () => {
    document.body.style.position = 'fixed';
    document.body.style.width = '100%';
  };

  const unlockScroll = () => {
    document.body.style.position = '';
    document.body.style.width = '';
  };

  document.querySelectorAll('input, textarea').forEach(el => {
    el.addEventListener('focus', lockScroll);
    el.addEventListener('blur', unlockScroll);
  });

</script>
<div id="mLoading" style="display:none;">
    <div class="mLoading-box">
      <div class="mSpinner"></div>
      <div class="mLoading-text">è™•ç†ä¸­â€¦</div>
    </div>
  </div>

<script>
(function () {
  // âœ… ç”¨æ›´ç©©é™£å˜…æ‰‹æ©Ÿåˆ¤æ–·ï¼ˆiPhone/Safari ä¸€å®šä¸­ï¼‰
  const isMobile =
    window.matchMedia("(max-width: 768px)").matches ||
    "ontouchstart" in window ||
    navigator.maxTouchPoints > 0;

  // âœ… ç„¡è«–ä¿‚ mobile å®š desktopï¼Œè¿”å›é é¢éƒ½è¦é—œæ‰ loading
  function hideLoading() {
    const overlay = document.getElementById("mLoading");
    if (overlay) overlay.style.display = "none";
    const btn1 = document.getElementById("analyzeBtn");
    const btn2 = document.getElementById("refreshBtn");
    if (btn1) { btn1.classList.remove("loading"); btn1.disabled = false; }
    if (btn2) { btn2.classList.remove("loading"); btn2.disabled = false; }
  }
  window.addEventListener("pageshow", hideLoading);
  window.addEventListener("load", hideLoading);

  // âœ… åªä¿‚ã€Œé¡¯ç¤º loadingã€å…ˆé™åˆ¶ mobileï¼ˆä½ æƒ³ desktop å””å½ˆå°±ä¿ç•™ï¼‰
  if (!isMobile) return;

  const overlay = document.getElementById("mLoading");
  if (!overlay) return;

  const textEL = overlay.querySelector(".mLoading-text");

  function setLoading(on, text) {
    if (text && textEL) textEL.textContent = text;
    overlay.style.display = on ? "block" : "none";
  }

  // âœ… ç¶ã€Œå€‹è‚¡åˆ†æã€form + button
  const analyzeBtn = document.getElementById("analyzeBtn");
  const analyzeForm = analyzeBtn ? analyzeBtn.closest("form") : null;
  if (analyzeForm && analyzeBtn) {
    analyzeForm.addEventListener("submit", () => {
      analyzeBtn.classList.add("loading");
      analyzeBtn.disabled = true;
      setLoading(true, "åˆ†æä¸­â€¦");
    });
  }

  // âœ… ç¶ã€Œæ‰‹å‹•æ›´æ–°ä»Šæ—¥å¸‚å ´ã€form + button
  const refreshBtn = document.getElementById("refreshBtn");
  const refreshForm = refreshBtn ? refreshBtn.closest("form") : null;
  if (refreshForm && refreshBtn) {
    refreshForm.addEventListener("submit", () => {
      refreshBtn.classList.add("loading");
      refreshBtn.disabled = true;
      setLoading(true, "æ›´æ–°å¸‚å ´ä¸­â€¦");
    });
  }
})();
</script>

<script>
async function loadPulse(){
  const topEl = document.getElementById("pulseTop");
  const badgesEl = document.getElementById("pulseBadges");
  const hintEl = document.getElementById("pulseHint");
  const detailEl = document.getElementById("pulseDetail");
  const updEl = document.getElementById("pulseUpdated");

  try{
    topEl.textContent = "è®€å–ä¸­...";
    badgesEl.innerHTML = "";
    hintEl.textContent = "";
    detailEl.textContent = "";
    updEl.textContent = "";

    const r = await fetch("/api/pulse", {cache:"no-store"});
    const data = await r.json();

    const fg = data.feargreed || {};
    const mk = data.market || {};

    // 1) é ‚éƒ¨ä¸€å¥ç¸½è¦½
    if (fg.ok && mk.ok){
      topEl.textContent = `FGï¼š${fg.score}/100ï¼ˆ${fg.label}ï¼‰ï½œä»Šæ—¥ç¸½ç‡ˆè™Ÿï¼š${mk.signal.emoji}${mk.signal.name}`;
    } else {
      topEl.textContent = "è®€å–å¤±æ•—ï¼ˆç¶²çµ¡æˆ–å¾Œç«¯éŒ¯èª¤ï¼‰";
    }

    // 2) badgesï¼šææ…Œè²ªå©ªç‡ˆè™Ÿ + ä»Šæ—¥ç¸½ç‡ˆè™Ÿ
    let hints = [];

    if (fg.ok && fg.signal){
      badgesEl.innerHTML += `
        <span class="fg-badge ${fg.signal.cls}">
          ${fg.signal.emoji} ææ…Œè²ªå©ªï¼š${fg.signal.name}ï¼ˆ${fg.score}ï¼‰
        </span>
      `;
      if (fg.signal.hint) hints.push(fg.signal.hint);
    }

    if (mk.ok && mk.signal){
      badgesEl.innerHTML += `
        <span class="fg-badge ${mk.signal.cls}">
          ${mk.signal.emoji} ä»Šæ—¥ç¸½ç‡ˆè™Ÿï¼š${mk.signal.name}ï¼ˆç¸½åˆ† ${mk.total}ï¼‰
        </span>
      `;
      if (mk.signal.hint) hints.push(mk.signal.hint);
    }

    hintEl.textContent = hints.join(" ï½œ ");

    // 3) è©³ç´°ï¼ˆå¯é¸ï¼šé¡¯ç¤ºVIXã€MA50ã€ä¸‰ç¥¨çµæœï¼‰
    if (fg.ok){
      const c = fg.components || {};
      detailEl.innerHTML =
        `VIXï¼š${c.vix}ï¼ˆåˆ†ä½ ${c.pct_vix}%ï¼‰ï½œSPYï¼š${c.spy}ï½œMA50ï¼š${c.ma50}ï½œè·MA50ï¼š${c.diff_pct_vs_ma50}%`;
    }

    if (mk.ok){
      const vv = (mk.votes || []).map(x => `${x.ticker}:${x.status}`).join(" / ");
      detailEl.innerHTML += `<br>æŠ•ç¥¨ï¼š${vv}`;
    }

    updEl.textContent = `æ›´æ–°ï¼š${data.updated || ""}`;

  }catch(e){
    topEl.textContent = "è®€å–å¤±æ•—ï¼ˆç¶²çµ¡æˆ–å¾Œç«¯éŒ¯èª¤ï¼‰";
    detailEl.textContent = String(e);
  }
}

// é é¢è¼‰å…¥å°±è·‘ä¸€æ¬¡
document.addEventListener("DOMContentLoaded", loadPulse);
</script>

<!-- Loading Overlay -->
<div id="loadingOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#0b1220; padding:16px 18px; border:1px solid rgba(255,255,255,.15); border-radius:12px; width:min(340px, 92vw); text-align:center;">
    <div id="loadingTitle" style="font-size:16px; font-weight:800;">è¿è¡Œä¸­â€¦</div>
    <div id="loadingSub" style="margin-top:6px; font-size:13px; opacity:.82;">Loadingâ€¦</div>
    <div style="margin-top:12px; font-size:12px; opacity:.65;">é¦–æ¬¡å¯èƒ½éœ€è¦ 5â€“15 ç§’</div>
  </div>
</div>

<script>
function showLoading(title, sub){
  const el = document.getElementById("loadingOverlay");
  const t = document.getElementById("loadingTitle");
  const s = document.getElementById("loadingSub");
  if(t) t.textContent = title || "è¿è¡Œä¸­â€¦";
  if(s) s.textContent = sub || "Loadingâ€¦";
  if(el) el.style.display = "flex";
}
</script>

</body>
</html>