<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Stock Bot</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#0b1220; --card:#0f1b2e; --muted:#9fb0c7; --text:#eaf1ff;
      --border:rgba(255,255,255,.10); --good:#20c997; --bad:#ff6b6b; --chip:#1b2b45;
      --btn:#6f5bff;
    }
    body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;}
    .wrap{max-width:1100px;margin:0 auto;padding:18px;}
    .row{display:flex;gap:14px;flex-wrap:wrap;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 10px 25px rgba(0,0,0,.25);}
    .card h2,.card h3{margin:0 0 10px 0;}
    .muted{color:var(--muted);font-size:13px}
    .btn{background:var(--btn);border:none;color:white;padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .input{width:100%;padding:12px 12px;border-radius:10px;border:1px solid var(--border);background:#081021;color:var(--text)}
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media(max-width:900px){.grid3{grid-template-columns:1fr}}
    .price{font-size:22px;font-weight:700}
    .chg.up{color:var(--good);font-weight:700}
    .chg.down{color:var(--bad);font-weight:700}
    .chip{display:inline-block;background:var(--chip);border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;margin:4px 6px 0 0}
    .pre{white-space:pre-wrap;word-wrap:break-word;background:#081021;border:1px solid var(--border);border-radius:12px;padding:12px;margin:10px 0}
    .sep{height:1px;background:var(--border);margin:14px 0}
    .badge-pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:600;}
    .badge-hot{background:rgba(255,77,79,.18);border:1px solid rgba(255,77,79,.35);}
    .badge-strong{background:rgba(82,196,26,.16);border:1px solid rgba(82,196,26,.35);}
    .badge-weak{background:rgba(250,173,20,.16);border:1px solid rgba(250,173,20,.35);}
    .badge-cold{background:rgba(24,144,255,.16);border:1px solid rgba(24,144,255,.35);}
    .badge-neutral{background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.18);}
    .grade{font-size:12px;padding:3px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.18);opacity:.95}
    .grade-a{background:rgba(82,196,26,.18)}
    .grade-b{background:rgba(255,255,255,.10)}
    .grade-c{background:rgba(255,77,79,.16)}
    .muted2{opacity:.85;font-size:12px;line-height:1.35}
    .badge {
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 12px;
    }

   .badge-hot { background:#7a1f1f; color:#ffb3b3; }
   .badge-strong { background:#14532d; color:#86efac; }
   .badge-weak { background:#1e3a8a; color:#93c5fd; }
   .badge-cold { background:#312e81; color:#c7d2fe; }

   .badge-grade {
     background:#334155;
     color:#e5e7eb;
    }

    .badge-support {
      background: #123f2d;
      color: #7CFFB2;
      border: 1px solid #2ecc71;
    }

    .badge-resist {
      background: #3a1a1a;
      color: #ff9c9c;
      border: 1px solid #e74c3c;
    }

    .badge-mid {
      background: #1f2937;
      color: #9ca3af;
      border: 1px solid #374151;
    }

    .rsi-low   { background:#3a1a1a; color:#ff9c9c; border:1px solid #e74c3c; }
    .rsi-weak  { background:#2b2a15; color:#ffd36a; border:1px solid #e0b34a; }
    .rsi-mid   { background:#1f2937; color:#9ca3af; border:1px solid #374151; }
    .rsi-strong{ background:#123f2d; color:#7cffb2; border:1px solid #2ecc71; }
    .rsi-high  { background:#2a1455; color:#c7b2ff; border:1px solid #8b5cf6; }

    /* RSI é¢œè‰²åˆ†çº§ */
    .rsi-low {
      background: rgba(46, 204, 113, 0.18);
      color: #2ecc71;
      border: 1px solid #2ecc71;
    }

    .rsi-weak {
      background: rgba(52, 152, 219, 0.18);
      color: #5dade2;
      border: 1px solid #5dade2;
    }

    .rsi-strong {
      background: rgba(241, 196, 15, 0.18);
      color: #f1c40f;
      border: 1px solid #f1c40f;
    }

    .rsi-high {
      background: rgba(231, 76, 60, 0.18);
      color: #e74c3c;
      border: 1px solid #e74c3c;
    }

    /* ===== å½©è‰² chips ===== */
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 13px;
      line-height: 1;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      white-space: nowrap;
    }

    /* MA / ä¸€èˆ¬æŒ‡æ¨™ï¼ˆè—è‰²ç³»ï¼‰ */
    .chip-ma {
      background: rgba(62, 152, 255, .18);
      border-color: rgba(62, 152, 255, .35);
      color: #bfe0ff;
    }

    /* RSI é¡è‰²ï¼ˆè·Ÿä½ æƒ³è¦çš„ï¼šè¶…è²·ç´…ã€æ¥è¿‘è¶…è²·é»ƒã€ä¸­æ€§ç°/è—ã€åå¼±åé’ã€è¶…è³£ç¶ ï¼‰ */
    .chip-rsi-low {   /* <=30 è¶…è³£ */
      background: rgba(46, 204, 113, .18);
      border-color: rgba(46, 204, 113, .35);
      color: #bff7d0;
    }
    .chip-rsi-weak {  /* 30~45 åå¼± */
      background: rgba(0, 206, 201, .16);
      border-color: rgba(0, 206, 201, .32);
      color: #bffaf7;
    }
    .chip-rsi-mid {   /* 45~60 ä¸­æ€§ */
      background: rgba(170, 180, 200, .14);
      border-color: rgba(170, 180, 200, .28);
      color: #e7ecf6;
    }
    .chip-rsi-strong {/* 60~70 åå¼·ï¼ˆé»ƒè‰²ï¼‰ */
      background: rgba(255, 193, 7, .18);
      border-color: rgba(255, 193, 7, .35);
      color: #ffe7a8;
    }
    .chip-rsi-high {  /* >=70 è¶…è²·ï¼ˆç´…è‰²ï¼‰ */
      background: rgba(255, 77, 79, .18);
      border-color: rgba(255, 77, 79, .38);
      color: #ffd0d0;
    }

    /* ===== è¶¨å‹¢åˆ†æ•¸ bar ===== */
    .score-wrap{
      margin-top: 10px;
    }
    .score-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color: rgba(255,255,255,.8);
      font-size: 13px;
    }
    .score-num{
      font-size: 20px;
      font-weight: 800;
      color: rgba(255,255,255,.95);
    }
    .score-bar{
      margin-top: 8px;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      overflow: hidden;
      border: 1px solid rgba(255,255,255,.06);
    }
    .score-fill{
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, #2ecc71 0%, #f1c40f 55%, #ff4d4f 100%);
    }

    /* âœ… é˜²æ­¢æ•´é æ©«å‘çˆ†å‡ºå» */
    html, body { overflow-x: hidden; }

    /* âœ… å¡ç‰‡å…§ä»»ä½•æ–‡å­—éƒ½è¦è­˜æ›è¡Œ */
    .card, .muted, .muted2, .ai-box, .ai-summary, .ai-advice {
      word-break: break-word;
      overflow-wrap: anywhere;
      white-space: normal;
    }

    /* âœ… å¦‚æœä½  AI å…§å®¹ä¿‚ç”¨ <pre> æˆ– code é¡¯ç¤ºï¼Œå’è¦ç‰¹åˆ¥è™•ç† */
    pre, code {
      white-space: pre-wrap;
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    /* âœ… åœ–è¡¨/å…§å®¹å””å¥½è¶…å‡ºå¡ç‰‡ */
    .card { overflow: hidden; }
    canvas { max-width: 100% !important; height: auto !important; display:block; }

    /* âœ… iPhone / æ‰‹æ©Ÿï¼šé˜²æ©«å‘çˆ†ç‰ˆ */
    html, body { max-width: 100%; overflow-x: hidden; }
    * { box-sizing: border-box; }

    /* âœ… å¤–æ¡†åŒå¡ç‰‡å””å¥½ç¡¬æ€§å¯¬åº¦ */
    .wrap { width: 100%; max-width: 100%; padding: 14px; }
    .card { width: 100%; max-width: 100%; overflow: hidden; }

    /* âœ… æ‰€æœ‰æ–‡å­—éƒ½å…è¨±æ–·è¡Œï¼ˆå°¤å…¶ AI å…§å®¹ï¼‰ */
    .card, .muted, .muted2, .ai, .ai-box, .ai-summary, .ai-advice {
      white-space: normal;
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    /* âœ… chip / badge æœƒå¥½å¤šå­—ï¼šè¦å¯ä»¥æ›è¡Œï¼‹å””å¥½è¶…å‡º */
    .chips, .badges, .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .chip, .badge {
      max-width: 100%;
      white-space: normal;
      overflow-wrap: anywhere;
    }

    /* âœ… åœ–è¡¨/canvas ä¸€å®šè¦è·Ÿå®¹å™¨ç¸®æ”¾ */
    canvas { max-width: 100% !important; height: auto !important; display: block; }

    /* âœ… æ‰‹æ©Ÿï¼šä¸‰æ ¼è®Šä¸€æ ¼ï¼Œé¿å… grid æ’çˆ† */
    @media (max-width: 640px) {
      .grid3 { grid-template-columns: 1fr !important; }
    }

    html, body {
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
      overscroll-behavior: none;
    }

    input, textarea {
      font-size: 16px !important;
    }

    input[type="text"], input[type="search"] {
      height: 44px;
      line-height: 44px;
      padding: 0 12px;
    }
  </style>
</head>
<body>
<div class="wrap">
  <!-- Single stock -->
  <div class="card">
    <h2>ğŸ” å€‹è‚¡åˆ†æï¼ˆæŠ€è¡“æŒ‡æ¨™ + AIï¼‰</h2>

    <form method="POST" action="/" style="margin-top:10px">
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <input class="input" name="ticker" placeholder="è¼¸å…¥ä»£è™Ÿï¼Œä¾‹å¦‚ NVDA / AAPL / TSLA / QQQ" value="{{ ticker }}" style="flex:1;min-width:220px">
        <button class="btn" type="submit">åˆ†æ</button>
      </div>
    </form>

    {% if error %}
      <div class="sep"></div>
      <div class="muted">âŒ {{ error }}</div>
    {% endif %}

    {% if indicators %}
      <div class="sep"></div>

      <h3 style="margin:0 0 8px 0">{{ indicators.ticker }}ã€€${{ indicators.last_price }}ã€€
        {% if indicators.change_pct is not none %}
          {% if indicators.change_pct >= 0 %}
            <span class="chg up">â–² {{ indicators.change_pct }}%</span>
          {% else %}
            <span class="chg down">â–¼ {{ indicators.change_pct }}%</span>
          {% endif %}
        {% endif %}
      </h3>
      <div class="muted">æ”¶å¸‚æ—¥ï¼š{{ indicators.last_date }}ï½œè¶¨å‹¢åˆ†æ•¸ï¼š{{ indicators.trend_score }}</div>

      <div class="score-wrap">
        <div class="score-row">
          <div>è¶¨å‹¢åˆ†æ•¸ï¼ˆ0â€“100ï¼‰ï¼š</div>
          <div class="score-num">{{ indicators.trend_score }}/100</div>
       </div>
       <div class="score-bar">
         <div class="score-fill" style="width: {{ indicators.trend_score }}%"></div>
       </div>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        {% if indicators.rsi is not none %}
          <span class="chip {{ indicators.rsi_class }}">
            RSI14 {{ indicators.rsi }}
            {% if indicators.rsi_label %}<span style="opacity:.85">ï¼ˆ{{ indicators.rsi_label.split(' ')[-1] }}ï¼‰</span>{% endif %}
          </span>
        {% endif %}
        <span class="chip">MA5 {{ indicators.ma5 }}</span>
        <span class="chip">MA20 {{ indicators.ma20 }}</span>
        <span class="chip">MA60 {{ indicators.ma60 }}</span>
        <span class="chip">MACD {{ indicators.macd }}</span>
        <span class="chip">BOLL {{ indicators.boll_lower }} ~ {{ indicators.boll_upper }}</span>
        <span class="chip">é‡ {{ indicators.volume_str }}ï¼ˆ20æ—¥å‡ {{ indicators.avg20_volume_str }}ï¼‰</span>
      </div>

      {% if indicators.high_52w and indicators.low_52w %}
        <div class="muted" style="margin-top:8px">
          52é€±ï¼š{{ indicators.low_52w }} ~ {{ indicators.high_52w }}ï½œè·é«˜ä½ï¼š{{ indicators.from_high_pct }}%
        </div>
      {% endif %}

      {% if indicators.tech_signals %}
        <div style="margin-top:10px">
          {% for s in indicators.tech_signals %}
            <span class="chip">{{ s.label }}</span>
          {% endfor %}
        </div>
      {% endif %}

      {% if ai_summary %}
        <div class="sep"></div>
        <div class="muted">ä¸€å¥è©±ç¸½è©•ï¼š</div>
        <pre>{{ ai_summary }}</pre>
      {% endif %}

      {% if ai_advice %}
        <div class="sep"></div>
        <div class="muted">AI è©³ç´°åˆ†æï¼š</div>
        <pre>{{ ai_advice }}</pre>
      {% endif %}

      <div class="sep"></div>
      <h3 style="margin:0 0 10px 0">ğŸ“ˆ æœ€è¿‘90æ—¥èµ°å‹¢</h3>
      <canvas id="priceChart" height="110"></canvas>

      <script>
        const labels = {{ chart_labels|tojson }};
        const prices = {{ chart_prices|tojson }};
        const ctx = document.getElementById('priceChart').getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: '{{ indicators.ticker }} Close',
              data: prices,
              tension: 0.2,
              pointRadius: 0,
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: true } },
            scales: {
              x: { ticks: { maxTicksLimit: 8 } }
            }
          }
        });
      </script>
    {% endif %}
  </div>

  <!-- Market Overview -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <div>
        <h2>ğŸ“Œ ä»Šæ—¥å¸‚å ´æ¦‚è¦½ï¼ˆSPY / QQQ / DIAï¼‰</h2>
        <div class="muted">æç¤ºï¼šå¦‚è¦‹åˆ°æ•¸æ“šèˆŠï¼ŒæŒ‰å³é‚Šã€Œæ‰‹å‹•æ›´æ–°ã€</div>
      </div>
      <form method="POST" action="/refresh_market" style="margin:0">
        <button class="btn" type="submit">æ‰‹å‹•æ›´æ–°å¸‚å ´</button>
      </form>
    </div>

    <div class="sep"></div>

    <div class="grid3">
      {% for m in market_overview %}
        <div class="card" style="padding:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3 style="margin:0">{{ m.ticker }}</h3>
            <div class="muted">æ›´æ–°ï¼š{{ m.updated_date if m.updated_date else "-" }}</div>
              {% if m.is_stale %}
                <span class="badge bg-warning text-dark" style="margin-left:6px;">
                  è³‡æ–™æœªæ›´æ–°
                </span>
              {% endif %}
          </div>

          {% if m.error %}
            <div class="muted">Error: {{ m.error }}</div>
          {% else %}
            <div style="display:flex;align-items:baseline;gap:10px;margin-top:6px">
              <div class="price">${{ '%.2f'|format(m.last_price) }}</div>
              {% if m.change_pct is not none %}
                {% if m.change_pct >= 0 %}
                  <div class="chg up">â–² {{ '%.2f'|format(m.change_pct) }}%</div>
                {% else %}
                  <div class="chg down">â–¼ {{ '%.2f'|format(m.change_pct) }}%</div>
                {% endif %}
              {% endif %}
            </div>

            <div class="muted" style="margin-top:8px">
              RSI14ï¼š{{ m.rsi14 if m.rsi14 is not none else "-" }}ã€€
              MA20ï¼š{{ m.ma20 if m.ma20 is not none else "-" }}ã€€
              MA60ï¼š{{ m.ma60 if m.ma60 is not none else "-" }}
            </div>

            {% if m.trend20_pct is not none %}
            <div class="muted" style="margin-top:6px">
              20æ—¥è¶‹åŠ¿ï¼š
              {% if m.trend20_dir == "up" %}
                <span style="color:#4ade80">â†‘ {{ m.trend20_pct }}%</span>
              {% elif m.trend20_dir == "down" %}
                <span style="color:#f87171">â†“ {{ m.trend20_pct }}%</span>
              {% else %}
                <span style="color:#a3a3a3">â†’ {{ m.trend20_pct }}%</span>
              {% endif %}
            </div>
            {% endif %}

            {% if m.ma_cross %}
            <div class="muted" style="margin-top:4px">
              {% if m.ma_cross == "golden" %}
                <span style="color:#facc15">âœ¨ é‡‘å‰ï¼ˆMA20 â†‘ MA60ï¼‰</span>
              {% elif m.ma_cross == "death" %}
                <span style="color:#fb7185">âš ï¸ æ­»å‰ï¼ˆMA20 â†“ MA60ï¼‰</span>
              {% endif %}
            </div>
            {% endif %}

            <div class="muted" style="margin-top:6px">
              è·é›¢ MA60ï¼š{{ m.dist_ma60 if m.dist_ma60 is not none else "-" }}%ã€€
              52é€±ï¼š{{ m.low_52w if m.low_52w is not none else "-" }} ~ {{ m.high_52w if m.high_52w is not none else "-" }}ã€€
              è·é«˜ä½ï¼š{{ m.from_high_pct if m.from_high_pct is not none else "-" }}%
            </div>

            {% if m.sr_text %}
            <div class="muted" style="margin-top:6px">
              ğŸ“ {{ m.sr_text }}
            </div>
            {% endif %}

            {% if m.support20 and m.resist20 %}
            <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap">

              {% if m.sr_zone == "support" %}
                <span class="badge badge-support">
                  é è¿‘æ”¯æ’‘ ({{ m.dist_support_pct }}%)
                </span>
              {% elif m.sr_zone == "resist" %}
                <span class="badge badge-resist">
                  æ¥è¿‘é˜»åŠ› ({{ m.dist_resist_pct }}%)
                </span>
              {% else %}
                <span class="badge badge-mid">
                  åŒºé—´ä¸­éƒ¨
                </span>
              {% endif %}

            </div>
            {% endif %}

            {% if m.weekly_text %}
              <div class="muted" style="margin-top:6px">é€±ç·šæ¦‚æ³ï¼š{{ m.weekly_text }}</div>
            {% endif %}

            {% if m.support20 and m.resist20 %}
              <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap">
                {% if m.sr_zone == "support" %}
                  <span class="badge badge-support">ğŸŸ¢ æ¥è¿‘æ”¯æ’ ({{ m.dist_support_pct }}%)</span>
                {% elif m.sr_zone == "resist" %}
                  <span class="badge badge-resist">ğŸ”´ æ¥è¿‘é˜»åŠ› ({{ m.dist_resist_pct }}%)</span>
                {% else %}
                  <span class="badge badge-mid">âšª å€é–“ä¸­æ®µ</span>
                {% endif %}
              </div>
            {% endif %}

            <div class="muted" style="margin-top:6px">
              æ”¯æ’‘/é˜»åŠ›(20æ—¥)ï¼š{{ m.support20 if m.support20 is not none else "--" }} ~ {{ m.resist20 if m.resist20 is not none else "--" }}
            </div>

            <div class="muted" style="margin-top:6px">
              æ³¢å‹•(ATR14%)ï¼š{{ (m.atr_pct|string + "%") if m.atr_pct is not none else "--" }}
            </div>

            {% if m.ticker != "SPY" and (m.rs_1m is not none or m.rs_3m is not none) %}
              <div class="muted" style="margin-top:6px">
                ç›¸å°SPYï¼š1M {{ m.rs_1m if m.rs_1m is not none else "--" }}%
                ï¼3M {{ m.rs_3m if m.rs_3m is not none else "--" }}%
              </div>
            {% endif %}

            <!-- ğŸ”¥ RSI ç‹€æ…‹ + å¸‚å ´è©•ç´š -->
           <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">

             {% if m.rsi14 is not none %}
               <span class="chip {{ m.rsi_class }}">RSI14 {{ "%.2f"|format(m.rsi14) }}</span>
             {% endif %}
             {% if m.ma20 is not none %}<span class="chip chip-ma">MA20 {{ m.ma20 }}</span>{% endif %}
             {% if m.ma60 is not none %}<span class="chip chip-ma">MA60 {{ m.ma60 }}</span>{% endif %}

             {% if m.grade %}
                  <span class="badge badge-grade">
                    è©•ç´š {{ m.grade }}
                  </span>
             {% endif %}

           </div>

           {% if m.conclusion %}
             <div class="muted" style="margin-top:6px">
               {{ m.conclusion }}
             </div>
           {% endif %}

            <div style="margin-top:8px">
              {% for s in m.signals %}
                <span class="chip">{{ s }}</span>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </div>

  <div style="height:14px"></div>

</div>
<!-- âœ… å¿…åšâ‘¡ï¼šé” scroll JSï¼ˆæ”¾è¿™é‡Œï¼‰ -->
<script>
  const lockScroll = () => {
    document.body.style.position = 'fixed';
    document.body.style.width = '100%';
  };

  const unlockScroll = () => {
    document.body.style.position = '';
    document.body.style.width = '';
  };

  document.querySelectorAll('input, textarea').forEach(el => {
    el.addEventListener('focus', lockScroll);
    el.addEventListener('blur', unlockScroll);
  });
</script>

</body>
</html>