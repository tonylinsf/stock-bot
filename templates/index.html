<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <title>Smart Stock Bot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap 5 -->
    <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
        body {
            background-color: #0b1220;
            color: #e5e7eb;
            font-family: -apple-system, BlinkMacSystemFont, "PingFang TC",
                "Microsoft JhengHei", system-ui, sans-serif;
        }

        .navbar-title {
            font-size: 2.2rem;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .brand-icon {
            width: 34px;
            height: 34px;
            border-radius: 8px;
            background: linear-gradient(135deg, #f97316, #ef4444);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
        }

        .brand-icon span {
            font-size: 20px;
        }

        .refresh-picks-btn {
            font-size: 0.7rem;
            line-height: 1.05;
            padding: 0.45rem 0.6rem;
            border-radius: 999px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .main-container {
            max-width: 1080px;
        }

        .card {
            background-color: #111827;
            border: 1px solid #374151;
            border-radius: 12px;
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
        }

        .card-header {
            border-bottom: 1px solid #1f2933;
            background: linear-gradient(90deg, #111827, #020617);
            border-radius: 12px 12px 0 0 !important;
        }

        .card-title {
            font-size: 1.05rem;
            font-weight: 600;
            color: #f9fafb;
        }

        .card-subtitle {
            font-size: 0.85rem;
            color: #9ca3af;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4f46e5, #6366f1);
            border-color: #4f46e5;
            font-weight: 600;
            letter-spacing: 0.03em;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #4338ca, #4f46e5);
            border-color: #4338ca;
        }

        .form-control {
            background-color: #020617;
            border-color: #4b5563;
            color: #e5e7eb;
        }

        .form-control:focus {
            background-color: #020617;
            border-color: #6366f1;
            color: #f9fafb;
            box-shadow: 0 0 0 1px #6366f1;
        }

        .text-muted {
            color: #9ca3af !important;
        }

        .alert-danger {
            border-radius: 10px;
        }

        /* å›¾è¡¨å¡ç‰‡å³ä¸Šè§’çš„ä»·æ ¼ + æ¶¨è·Œ */
        .chart-header-info {
            position: absolute;
            top: 9px;
            right: 18px;
            font-size: 0.88rem;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chart-ticker-label {
            background-color: rgba(0, 0, 0, 0.75);
            border-radius: 999px;
            padding: 3px 12px;
            font-weight: 600;
            color: #f9fafb;
        }

        .change-positive {
            color: #22c55e;
            font-weight: 700;
        }

        .change-negative {
            color: #ef4444;
            font-weight: 700;
        }

        /* AI åˆ†æåŒº */
        .ai-card {
            margin-top: 18px;
        }

        .ai-text {
            white-space: pre-wrap;
            font-size: 0.93rem;
            line-height: 1.6;
            color: #e5e7eb;
        }

        /* æŠ€æœ¯æŒ‡æ ‡åŒº */
        .indicator-badge {
            font-size: 0.78rem;
            border-radius: 999px;
            padding: 4px 9px;
            margin-right: 6px;
            margin-bottom: 6px;
            border: 1px solid #4b5563;
            background: rgba(15, 23, 42, 0.95);
        }

        .indicator-label {
            color: #e5e7eb;
            font-weight: 600;
        }

        .indicator-value {
            color: #facc15; /* é»ƒè‰²ï¼Œé†’ç›® */
            font-weight: 700;
            margin-left: 4px;
        }

        /* æŠ€è¡“ä¿¡è™Ÿ badge */
        .signal-badge {
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 0.78rem;
            border: 1px solid #4b5563;
        }

        .signal-badge-risk {
            background: rgba(239, 68, 68, 0.12);
            color: #fecaca;
            border-color: #b91c1c;
        }

        .signal-badge-opportunity {
            background: rgba(34, 197, 94, 0.12);
            color: #bbf7d0;
            border-color: #15803d;
        }

        .signal-badge-bull {
            background: rgba(56, 189, 248, 0.12);
            color: #bae6fd;
            border-color: #0ea5e9;
        }

        .signal-badge-bear {
            background: rgba(249, 115, 22, 0.12);
            color: #fed7aa;
            border-color: #ea580c;
        }

        /* è¶¨å‹¢åˆ†æ•¸ */
        .trend-score-number {
            font-weight: 700;
            font-size: 1rem;
            color: #e5e7eb;
        }

        .trend-score-bar {
            height: 6px;
            width: 100%;
            background: #020617;
            border-radius: 999px;
            overflow: hidden;
        }

        .trend-score-bar-inner {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #eab308, #ef4444);
        }

        /* æ¯æ—¥ç²¾é¸å¡ç‰‡ */
        .pick-rank {
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 999px;
            border: 1px solid #4b5563;
            color: #e5e7eb;
        }

        .pick-ticker {
            font-size: 1.05rem;
            font-weight: 700;
            color: #f9fafb;
        }

        .pick-price {
            font-size: 0.95rem;
            color: #e5e7eb;
        }

        .pick-meta-line {
            font-size: 0.8rem;
            color: #fef3c7;
            line-height: 1.45;
        }

        .ai-summary-label {
            font-weight: 600;
            color: #facc15;
            font-size: 0.9rem;
        }

        .ai-summary-text {
            font-size: 0.9rem;
        }

        .ai-disclaimer {
            margin-top: 10px;
            font-size: 0.8rem;
            color: #9ca3af;
        }

        canvas {
            max-height: 360px;
        }
    </style>
</head>

<body>
    <div class="container py-4 main-container">
        <!-- é¡¶éƒ¨æ ‡é¢˜ -->
        <div class="d-flex align-items-center mb-3">
            <div class="brand-icon">
                <span>ğŸ“ˆ</span>
            </div>
            <div>
                <div class="navbar-title">Smart Stock Bot</div>
                <div class="text-muted" style="font-size: 0.85rem">
                    è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿï¼ŒæŸ¥çœ‹èµ°å‹¢ + æŠ€è¡“æŒ‡æ¨™ + AI åˆ†æå»ºè­°ï¼ˆéæŠ•è³‡å»ºè­°ï¼‰
                </div>
            </div>
        </div>

        <!-- æœç´¢è¡¨å• -->
        <form method="POST" class="mb-3">
            <div class="input-group">
                <input
                    type="text"
                    name="ticker"
                    class="form-control"
                    placeholder="è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿï¼Œä¾‹å¦‚ï¼šAAPLã€NVDAã€QQQ"
                    value="{{ ticker or '' }}"
                    required
                />
                <button class="btn btn-primary" type="submit">åˆ†æ</button>
            </div>
        </form>

        <!-- é”™è¯¯æ˜¾ç¤ºï¼ˆå¦‚æœæœ‰ï¼‰ -->
        {% if error %}
        <div class="alert alert-danger" role="alert">
            {{ error }}
        </div>
        {% endif %}

        <!-- ä»Šæ—¥ Smart AI ç²¾é¸ -->
        {% if daily_picks %}
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="card-title mb-0">âœ¨ ä»Šæ—¥ Smart AI ç²¾é¸ï¼ˆä¾†è‡ªè‚¡ç¥¨æ± ï¼‰</div>
                <div class="text-muted" style="font-size: 0.8rem;">
                    æ¯æ—¥æŒ‰ RSI + MA60 è‡ªå‹•ç¯©é¸ï¼Œä¸¦ç”± AI çµ¦å‡ºè§€å¯Ÿé‡é»
                </div>
            </div>

            <!-- å³è¾¹ï¼šæ‰‹åŠ¨åˆ·æ–°æŒ‰é’® -->
            <form method="post" class="mb-0">
              <button
                type="submit"
                name="refresh_picks"
                value="1"
                class="btn btn-outline-light btn-sm refresh-picks-btn"
                title="é‡æ–°ç”Ÿæˆä»Šæ—¥ç²¾é€‰"
              >
                ğŸ”„<br>é‡æ–°<br>ç²¾é€‰
              </button>
            </form>
          </div>

            <div class="card-body">
                <div class="row g-3">
                    {% for p in daily_picks %}
                    <div class="col-md-4">
                        <div class="p-3 rounded-3" style="background: #020617; border: 1px solid #1f2937;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="pick-rank">ç¬¬ {{ p.rank }} å</span>
                                <span class="pick-ticker">{{ p.ticker }}</span>
                            </div>
                            <div class="mb-1 pick-price">
                                æœ€æ–°è‚¡åƒ¹ï¼š<strong>${{ '%.2f'|format(p.last_price) }}</strong>
                                {% if p.change_pct >= 0 %}
                                    <span class="change-positive ms-1">â–² {{ '%.2f'|format(p.change_pct) }}%</span>
                                {% else %}
                                    <span class="change-negative ms-1">â–¼ {{ '%.2f'|format(p.change_pct) }}%</span>
                                {% endif %}
                            </div>
                            <div class="pick-meta mb-2">
                                <span class="badge rounded-pill bg-warning text-dark">
                                    RSI {{ '%.1f'|format(p.rsi or 0) }}
                                </span>

                                <span class="badge rounded-pill bg-info text-dark ms-1">
                                     MA60 {{ '%.1f'|format(p.ma60 or 0) }}
                                </span>

                                <div class="pick-meta-line">
                                    åƒ¹æ ¼ç›¸å° MA60ï¼šç´„ {{ '%.2f'|format(p.dist_pct or 0) }}%
                                </div>

                                <div class="pick-meta-line">
                                    æˆäº¤é‡ï¼šç´„ {{ p.volume_str }}
                                </div>

                            </div>
                            {% if p.rank_text %}
                            <div class="pick-meta-line mb-1">
                                {{ p.rank_text }}
                            </div>
                            {% endif %}
                            {% if p.safe_text %}
                            <div class="pick-meta-line mb-1">
                                {{ p.safe_text }}
                            </div>
                            {% endif %}
                            {% if p.fair_text %}
                            <div class="pick-meta-line mb-1">
                                {{ p.fair_text }}
                            </div>
                            {% endif %}
                            {% if p.reason %}
                            <div class="mt-2" style="font-size:0.8rem; color:#d1d5db;">
                                {{ p.reason }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="mt-2 text-muted" style="font-size: 0.75rem;">
                    âš ï¸ ç²¾é¸çµæœåªä¿‚æ ¹æ“šæŠ€è¡“æŒ‡æ¨™ + AI åˆ†æï¼Œå””æ§‹æˆä»»ä½•è²·è³£å»ºè­°ã€‚
                </div>
            </div>
        </div>
        {% endif %}

        <!-- è‚¡ç¥¨ä¿¡æ¯ + æŠ€è¡“æŒ‡æ¨™ -->
        {% if indicators %}
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <div class="card-title mb-0">
                        ğŸ“Œ è‚¡ç¥¨è³‡è¨Š
                    </div>
                    <div class="card-subtitle">
                        è‚¡ç¥¨ä»£è™Ÿï¼š<strong>{{ indicators.ticker }}</strong>
                    </div>
                </div>
                <div style="text-align: right; font-size: 0.9rem; color:#e5e7eb;">
                    <div>
                        æœ€æ–°æ”¶å¸‚åƒ¹ï¼š
                        <strong>${{ '%.2f'|format(indicators.last_price) }}</strong>
                    </div>
                    <div>æ›´æ–°æ—¥æœŸï¼š{{ indicators.last_date }}</div>
                    <div>
                        æ¼²è·Œï¼š
                        {% if indicators.change_pct >= 0 %}
                        <span class="change-positive">
                            â–² {{ '%.2f'|format(indicators.change_pct) }}%
                        </span>
                        {% else %}
                        <span class="change-negative">
                            â–¼ {{ '%.2f'|format(indicators.change_pct) }}%
                        </span>
                        {% endif %}
                    </div>
                    <div class="mt-1" style="font-size:0.8rem; color:#9ca3af;">
                        æˆäº¤é‡ï¼šç´„ {{ indicators.volume_str }} ï½œ 20 æ—¥å‡é‡ï¼šç´„ {{ indicators.avg20_volume_str }}
                    </div>
                    {% if indicators.low_52w and indicators.high_52w %}
                    <div class="mt-1" style="font-size:0.8rem; color:#9ca3af;">
                        52 é€±å€é–“ï¼š{{ '%.2f'|format(indicators.low_52w) }} ~ {{ '%.2f'|format(indicators.high_52w) }}
                        {% if indicators.from_high_pct is not none %}
                            ï¼ˆç¾åƒ¹è·é›¢ 52 é€±é«˜ä½ï¼šç´„ {{ '%.2f'|format(indicators.from_high_pct) }}%ï¼‰
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="card-body">
                <div class="mb-2" style="font-size: 0.9rem; color: #9ca3af">
                    èµ°å‹¢æ¦‚æ³ï¼š{{ indicators.trend_text }}
                </div>

                <!-- è¶¨å‹¢åˆ†æ•¸ -->
                {% if indicators.trend_score is not none %}
                <div class="mb-3">
                    <div class="small text-muted mb-1">è¶¨å‹¢åˆ†æ•¸ï¼ˆ0â€“100ï¼‰ï¼š</div>
                    <div class="d-flex align-items-center gap-2">
                        <div class="trend-score-number">
                            {{ indicators.trend_score }}/100
                        </div>
                        <div class="trend-score-bar">
                            <div class="trend-score-bar-inner" style="width: {{ indicators.trend_score }}%;"></div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <div class="mb-2" style="font-size: 0.9rem; color: #9ca3af">
                    æŠ€è¡“æŒ‡æ¨™ï¼ˆæœ€è¿‘ä¸€æ—¥ï¼‰ï¼š
                </div>
                <div class="d-flex flex-wrap mb-2">
                    <div class="indicator-badge">
                        <span class="indicator-label">RSI14</span>
                        <span class="indicator-value">
                            {{ '%.2f'|format(indicators.rsi) }}
                        </span>
                    </div>
                    <div class="indicator-badge">
                        <span class="indicator-label">MA5</span>
                        <span class="indicator-value">
                            {{ '%.2f'|format(indicators.ma5) }}
                        </span>
                    </div>
                    <div class="indicator-badge">
                        <span class="indicator-label">MA20</span>
                        <span class="indicator-value">
                            {{ '%.2f'|format(indicators.ma20) }}
                        </span>
                    </div>
                    <div class="indicator-badge">
                        <span class="indicator-label">MA60</span>
                        <span class="indicator-value">
                            {{ '%.2f'|format(indicators.ma60) }}
                        </span>
                    </div>
                    <div class="indicator-badge">
                        <span class="indicator-label">MACD</span>
                        <span class="indicator-value">
                            {{ '%.4f'|format(indicators.macd) }}
                        </span>
                    </div>
                    <div class="indicator-badge">
                        <span class="indicator-label">BOLL ä¸Šè»Œ</span>
                        <span class="indicator-value">
                            {{ '%.2f'|format(indicators.boll_upper) }}
                        </span>
                    </div>
                    <div class="indicator-badge">
                        <span class="indicator-label">BOLL ä¸­è»Œ</span>
                        <span class="indicator-value">
                            {{ '%.2f'|format(indicators.boll_mid) }}
                        </span>
                    </div>
                    <div class="indicator-badge">
                        <span class="indicator-label">BOLL ä¸‹è»Œ</span>
                        <span class="indicator-value">
                            {{ '%.2f'|format(indicators.boll_lower) }}
                        </span>
                    </div>
                </div>

                <!-- æŠ€è¡“ä¿¡è™Ÿ -->
                {% if indicators.tech_signals %}
                <div class="mb-1" style="font-size: 0.9rem; color: #9ca3af">
                    æŠ€è¡“ä¿¡è™Ÿï¼ˆç³»çµ±ç°¡å–®åˆ¤æ–·ï¼‰ï¼š
                </div>
                <div class="d-flex flex-wrap gap-2 mb-2">
                    {% for s in indicators.tech_signals %}
                        {% set cls = "signal-badge" %}
                        {% if s.level == "risk" %}
                            {% set cls = cls + " signal-badge-risk" %}
                        {% elif s.level == "opportunity" %}
                            {% set cls = cls + " signal-badge-opportunity" %}
                        {% elif s.level == "bull" %}
                            {% set cls = cls + " signal-badge-bull" %}
                        {% elif s.level == "bear" %}
                            {% set cls = cls + " signal-badge-bear" %}
                        {% endif %}
                        <span class="{{ cls }}">
                            {{ s.label }}
                        </span>
                    {% endfor %}
                </div>
                <div style="font-size:0.8rem; color:#9ca3af;">
                    {% for s in indicators.tech_signals %}
                        â€¢ {{ s.label }}ï¼š{{ s.text }}<br />
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- ä»·æ ¼å›¾è¡¨å¡ -->
        <div class="card mb-3 position-relative">
            <div class="card-header d-flex align-items-center">
                <div class="card-title mb-0">ğŸ“Š æœ€è¿‘ 3 å€‹æœˆèµ°å‹¢</div>
            </div>
            <div class="card-body">
                <!-- å›¾è¡¨å³ä¸Šè§’ï¼šè‚¡å + ä»·æ ¼ + æ¶¨è·Œ -->
                {% if indicators %}
                <div class="chart-header-info">
                    <div class="chart-ticker-label">
                        {{ indicators.ticker }} ${{ '%.2f'|format(indicators.last_price) }}
                    </div>
                    {% if indicators.change_pct >= 0 %}
                    <div class="change-positive">â–² {{ '%.2f'|format(indicators.change_pct) }}%</div>
                    {% else %}
                    <div class="change-negative">â–¼ {{ '%.2f'|format(indicators.change_pct) }}%</div>
                    {% endif %}
                </div>
                {% endif %}
                <canvas id="priceChart"></canvas>
            </div>
        </div>

        <!-- AI å»ºè­° -->
       {% if ai_advice %}
       <div class="card ai-card">
           <div class="card-header d-flex align-items-center">
               <div class="card-title mb-0">ğŸ¤– AI åˆ†æå»ºè­°</div>
           </div>
           <div class="card-body ai-text">

               {% if ai_summary %}
               <div class="ai-summary mb-2">
                   <span class="ai-summary-label">âš¡ ä¸€å¥è©±æŠ€è¡“ç¸½è©•ï¼š</span>
                   <span class="ai-summary-text">{{ ai_summary }}</span>
               </div>
               {% endif %}

               <div>
                   {{ ai_advice }}
               </div>

               <div class="ai-disclaimer">
                   âš ï¸ ä»¥ä¸Šåˆ†æåªä¾›åƒè€ƒï¼Œä¸¦ä¸æ§‹æˆä»»ä½•è²·è³£å»ºè­°æˆ–ä¿è­‰ã€‚
                   æŠ•è³‡æ¶‰åŠé¢¨éšªï¼Œè«‹æ ¹æ“šè‡ªå·±é¢¨éšªæ‰¿å—èƒ½åŠ›åŠå¯¦éš›æƒ…æ³ç¨ç«‹åˆ¤æ–·ã€‚
               </div>
           </div>
        </div>
        {% endif %}
    </div>

    <!-- Chart.js åˆå§‹åŒ– -->
    <script>
        const labels = {{ chart_labels|tojson|default('[]') }};
        const prices = {{ chart_prices|tojson|default('[]') }};

        const ctx = document.getElementById("priceChart").getContext("2d");

        const chart = new Chart(ctx, {
            type: "line",
            data: {
                labels: labels,
                datasets: [
                    {
                        label: "æ”¶ç›¤åƒ¹",
                        data: prices,
                        tension: 0.25,
                        borderWidth: 2,
                        pointRadius: 0,
                        borderColor: "#38bdf8",
                        fill: false,
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        ticks: {
                            color: "#9ca3af",
                            maxRotation: 0,
                            minRotation: 0,
                            autoSkip: true,
                            maxTicksLimit: 10,
                        },
                        grid: {
                            color: "#1f2933",
                        },
                    },
                    y: {
                        ticks: {
                            color: "#9ca3af",
                        },
                        grid: {
                            color: "#111827",
                        },
                    },
                },
                plugins: {
                    legend: {
                        display: false,
                    },
                    tooltip: {
                        mode: "index",
                        intersect: false,
                        backgroundColor: "rgba(15, 23, 42, 0.95)",
                        titleColor: "#e5e7eb",
                        bodyColor: "#e5e7eb",
                        borderColor: "#4b5563",
                        borderWidth: 1,
                        padding: 10,
                        callbacks: {
                            label: (ctx) => {
                                const v = ctx.parsed.y;
                                return " æ”¶ç›¤åƒ¹: " + v.toFixed(2);
                            },
                        },
                    },
                },
                interaction: {
                    mode: "index",
                    intersect: false,
                },
            },
        });
    </script>
</body>
</html>