<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <title>Smart Stock Bot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap 5 -->
    <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
        body {
            background-color: #0b1220;
            color: #e5e7eb;
            font-family: -apple-system, BlinkMacSystemFont, "PingFang TC",
                "Microsoft JhengHei", system-ui, sans-serif;
        }

        .navbar-title {
            font-size: 2.2rem;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .brand-icon {
            width: 34px;
            height: 34px;
            border-radius: 8px;
            background: linear-gradient(135deg, #f97316, #ef4444);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
        }

        .brand-icon span {
            font-size: 20px;
        }

        .main-container {
            max-width: 1080px;
        }

        .card {
            background-color: #111827;
            border: 1px solid #374151;
            border-radius: 12px;
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
        }

        .card-header {
            border-bottom: 1px solid #1f2933;
            background: linear-gradient(90deg, #111827, #020617);
            border-radius: 12px 12px 0 0 !important;
        }

        .card-title {
            font-size: 1.05rem;
            font-weight: 600;
            color: #f9fafb;
        }

        .card-subtitle {
            font-size: 0.85rem;
            color: #9ca3af;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4f46e5, #6366f1);
            border-color: #4f46e5;
            font-weight: 600;
            letter-spacing: 0.03em;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #4338ca, #4f46e5);
            border-color: #4338ca;
        }

        .form-control {
            background-color: #020617;
            border-color: #4b5563;
            color: #e5e7eb;
        }

        .form-control:focus {
            background-color: #020617;
            border-color: #6366f1;
            color: #f9fafb;
            box-shadow: 0 0 0 1px #6366f1;
        }

        .text-muted {
            color: #9ca3af !important;
        }

        .alert-danger {
            border-radius: 10px;
        }

        /* åœ–è¡¨å¡ç‰‡å³ä¸Šè§’çš„åƒ¹æ ¼ + æ¼²è·Œ */
        .chart-header-info {
            position: absolute;
            top: 9px;
            right: 18px;
            font-size: 0.88rem;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chart-ticker-label {
            background-color: rgba(0, 0, 0, 0.75);
            border-radius: 999px;
            padding: 3px 12px;
            font-weight: 600;
            color: #f9fafb;
        }

        .change-positive {
            color: #22c55e;
            font-weight: 700;
        }

        .change-negative {
            color: #ef4444;
            font-weight: 700;
        }

        /* AI åˆ†æå€ */
        .ai-card {
            margin-top: 18px;
        }

        .ai-text {
            white-space: pre-wrap;
            font-size: 0.93rem;
            line-height: 1.6;
            color: #e5e7eb;
        }

        .ai-summary-label {
            font-weight: 600;
            color: #fbbf24;
        }

        .ai-summary-text {
            color: #e5e7eb;
        }

        /* æŠ€è¡“æŒ‡æ¨™å€ */
        .indicator-badge {
            font-size: 0.78rem;
            border-radius: 999px;
            padding: 4px 9px;
            margin-right: 6px;
            margin-bottom: 6px;
            border: 1px solid #4b5563;
            background: rgba(15, 23, 42, 0.95);
        }

        .indicator-label {
            color: #e5e7eb;
            font-weight: 600;
        }

        .indicator-value {
            color: #facc15; /* é»ƒè‰²ï¼Œé†’ç›® */
            font-weight: 700;
            margin-left: 4px;
        }

        canvas {
            max-height: 360px;
        }

        /* ===== æ¯æ—¥ç²¾é¸å¡ç‰‡ ===== */

        .pick-card {
            border-radius: 16px;
            padding: 14px 14px 12px 14px;
            background: radial-gradient(circle at top left, #1f2937 0%, #020617 60%);
            border: 1px solid rgba(148, 163, 184, 0.3);
            min-height: 230px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .pick-ticker {
            font-weight: 800;
            font-size: 1.1rem;
            color: #ffffff;
            text-shadow: 0 0 6px rgba(0, 0, 0, 0.7);
        }

        .pick-latest {
            color: #e5e7eb;
            font-size: 0.85rem;
        }

        .pick-latest-price {
            color: #fef08a;
            font-weight: 700;
        }

        .pick-price {
            color: #fef08a; /* æŸ”å’Œäº®é»ƒè‰² */
            font-weight: 700;
            font-size: 0.95rem;
        }

        .pick-change-pos {
            color: #22c55e;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .pick-change-neg {
            color: #ef4444;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .pick-badges .badge {
            font-size: 0.7rem;
            border-radius: 999px;
            padding: 4px 9px;
        }

        .pick-badges .text-warning {
            background-color: rgba(234, 179, 8, 0.15);
        }

        .pick-badges .text-info {
            background-color: rgba(56, 189, 248, 0.15);
        }

        .pick-meta {
            margin-top: 4px;
            margin-bottom: 4px;
        }

        .pick-meta-line {
            font-size: 0.8rem;
            color: #e5e7eb;
            line-height: 1.4;
        }

        .pick-reason {
            font-size: 0.8rem;
            color: #cbd5f5;
        }

        .pick-footer-note {
            font-size: 0.75rem;
        }
    </style>
</head>

<body>
    <div class="container py-4 main-container">
        <!-- é¡¶éƒ¨æ ‡é¢˜ -->
        <div class="d-flex align-items-center mb-3">
            <div class="brand-icon">
                <span>ğŸ“ˆ</span>
            </div>
            <div>
                <div class="navbar-title">Smart Stock Bot</div>
                <div class="text-muted" style="font-size: 0.85rem">
                    è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿï¼ŒæŸ¥çœ‹èµ°å‹¢ + æŠ€è¡“æŒ‡æ¨™ + AI åˆ†æå»ºè­°ï¼ˆéæŠ•è³‡å»ºè­°ï¼‰
                </div>
            </div>
        </div>

        <!-- æœç´¢è¡¨å• -->
        <form method="POST" class="mb-3">
            <div class="input-group">
                <input
                    type="text"
                    name="ticker"
                    class="form-control"
                    placeholder="è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿï¼Œä¾‹å¦‚ï¼šAAPLã€NVDAã€QQQ"
                    value="{{ ticker or '' }}"
                    required
                />
                <button class="btn btn-primary" type="submit">åˆ†æ</button>
            </div>
        </form>

        <!-- é”™è¯¯æ˜¾ç¤ºï¼ˆå¦‚æœæœ‰ï¼‰ -->
        {% if error %}
        <div class="alert alert-danger" role="alert">
            {{ error }}
        </div>
        {% endif %}

        <!-- ====== ä»Šæ—¥ Smart AI ç²¾é¸ ====== -->
        {% if daily_picks %}
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <div class="card-title mb-0">ğŸŒŸ ä»Šæ—¥ Smart AI ç²¾é¸</div>
                    <div class="card-subtitle">
                        å¾ S&P 500 ç¯„åœä¸­ï¼Œæ ¹æ“š RSI + 60 æ—¥å‡ç·šç­‰æŠ€è¡“æŒ‡æ¨™ï¼Œè‡ªå‹•æ€é¸å‡ºæœ€å¤š 3 éš»åè¶…è³£æˆ–å¯èƒ½ä½ä¼°çš„è§€å¯Ÿè‚¡ç¥¨ï¼ˆç¨‹å¼åŒ–ç¯©é¸ï¼Œéäººå·¥æ¨è–¦ï¼‰ã€‚
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    {% for pick in daily_picks %}
                    <div class="col-md-4">
                        <div class="pick-card">
                            <div>
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <div class="pick-ticker">
                                        #{{ pick.rank }} {{ pick.ticker }}
                                    </div>
                                    <div class="text-end">
                                        <div class="pick-price">
                                            ${{ '%.2f'|format(pick.last_price or 0) }}
                                        </div>
                                        {% if pick.change_pct is not none and pick.change_pct >= 0 %}
                                        <span class="pick-change-pos">
                                            â–² {{ '%.2f'|format(pick.change_pct) }}%
                                        </span>
                                        {% elif pick.change_pct is not none %}
                                        <span class="pick-change-neg">
                                            â–¼ {{ '%.2f'|format(pick.change_pct) }}%
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="pick-latest small mb-1">
                                    æœ€æ–°åƒ¹ï¼š
                                    <span class="pick-latest-price">
                                        ${{ '%.2f'|format(pick.last_price or 0) }}
                                    </span>
                                </div>

                                <div class="pick-badges mb-1">
                                    <span class="badge rounded-pill text-warning">
                                        RSI {{ '%.1f'|format(pick.rsi or 0) }}
                                    </span>
                                    <span class="badge rounded-pill text-info">
                                        MA60 {{ '%.1f'|format(pick.ma60 or 0) }}
                                    </span>
                                </div>

                                <!-- AI æ’å + å®‰å…¨è²·å…¥å€ + åˆç†åƒ¹ -->
                                <div class="pick-meta">
                                    {% if pick.rank_text %}
                                    <div class="pick-meta-line">
                                        {{ pick.rank_text }}
                                    </div>
                                    {% endif %}

                                    {% if pick.safe_text %}
                                    <div class="pick-meta-line">
                                        {{ pick.safe_text }}
                                    </div>
                                    {% endif %}

                                    {% if pick.fair_text %}
                                    <div class="pick-meta-line">
                                        {{ pick.fair_text }}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- è©³ç´°åˆ†æ -->
                                <div class="pick-reason">
                                    {{ pick.reason }}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="pick-footer-note text-muted mt-2">
                    âš ï¸ ä»¥ä¸Šç‚ºç¨‹å¼æ ¹æ“šæŠ€è¡“æŒ‡æ¨™è‡ªå‹•ç¯©é¸ï¼Œåªä¾›åƒè€ƒï¼Œä¸¦ä¸æ§‹æˆä»»ä½•è²·è³£å»ºè­°ã€‚
                </div>
            </div>
        </div>
        {% endif %}

        <!-- è‚¡ç¥¨ä¿¡æ¯ + æŠ€è¡“æŒ‡æ¨™ -->
        {% if indicators %}
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <div class="card-title mb-0">
                        ğŸ“Œ è‚¡ç¥¨è³‡è¨Š
                    </div>
                    <div class="card-subtitle">
                        è‚¡ç¥¨ä»£è™Ÿï¼š<strong>{{ indicators.ticker }}</strong>
                    </div>
                </div>
                <div style="text-align: right; font-size: 0.9rem; color:#e5e7eb;">
                    <div>
                        æœ€æ–°æ”¶å¸‚åƒ¹ï¼š
                        <strong>${{ '%.2f'|format(indicators.last_price) }}</strong>
                    </div>
                    <div>æ›´æ–°æ—¥æœŸï¼š{{ indicators.last_date }}</div>
                    <div>
                        æ¼²è·Œï¼š
                        {% if indicators.change_pct >= 0 %}
                        <span class="change-positive">
                            â–² {{ '%.2f'|format(indicators.change_pct) }}%
                        </span>
                        {% else %}
                        <span class="change-negative">
                            â–¼ {{ '%.2f'|format(indicators.change_pct) }}%
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="card-body">
                <div class="mb-2" style="font-size: 0.9rem; color: #9ca3af">
                    èµ°å‹¢æ¦‚æ³ï¼š{{ indicators.trend_text }}
                </div>

                <div class="mb-2" style="font-size: 0.9rem; color: #9ca3af">
                    æŠ€è¡“æŒ‡æ¨™ï¼ˆæœ€è¿‘ä¸€æ—¥ï¼‰ï¼š
                </div>
                <div class="d-flex flex-wrap">
                    <div class="indicator-badge">
                        <span class="indicator-label">RSI14</span>
                        <span class="indicator-value">
                            {{ '%.2f'|format(indicators.rsi) }}
                        </span>
                    </div>
                    <div class="indicator-badge">
                        <span class="indicator-label">MA5</span>
                        <span class="indicator-value">
                            {{ '%.2f'|format(indicators.ma5) }}
                        </span>
                    </div>
                    <div class="indicator-badge">
                        <span class="indicator-label">MA20</span>
                        <span class="indicator-value">
                            {{ '%.2f'|format(indicators.ma20) }}
                        </span>
                    </div>
                    <div class="indicator-badge">
                        <span class="indicator-label">MA60</span>
                        <span class="indicator-value">
                            {{ '%.2f'|format(indicators.ma60) }}
                        </span>
                    </div>
                    <div class="indicator-badge">
                        <span class="indicator-label">MACD</span>
                        <span class="indicator-value">
                            {{ '%.4f'|format(indicators.macd) }}
                        </span>
                    </div>

                    <!-- å¸ƒæ—å¸¶ -->
                    <div class="indicator-badge">
                        <span class="indicator-label">BOLL ä¸Šè»Œ</span>
                        <span class="indicator-value">
                            {{ '%.2f'|format(indicators.boll_upper) }}
                        </span>
                    </div>
                    <div class="indicator-badge">
                        <span class="indicator-label">BOLL ä¸­è»Œ</span>
                        <span class="indicator-value">
                            {{ '%.2f'|format(indicators.boll_mid) }}
                        </span>
                    </div>
                    <div class="indicator-badge">
                        <span class="indicator-label">BOLL ä¸‹è»Œ</span>
                        <span class="indicator-value">
                            {{ '%.2f'|format(indicators.boll_lower) }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- ä»·æ ¼å›¾è¡¨å¡ -->
        <div class="card mb-3 position-relative">
            <div class="card-header d-flex align-items-center">
                <div class="card-title mb-0">ğŸ“Š æœ€è¿‘ 3 å€‹æœˆèµ°å‹¢</div>
            </div>
            <div class="card-body">
                <!-- å›¾è¡¨å³ä¸Šè§’ï¼šè‚¡å + ä»·æ ¼ + æ¶¨è·Œ -->
                {% if indicators %}
                <div class="chart-header-info">
                    <div class="chart-ticker-label">
                        {{ indicators.ticker }} ${{ '%.2f'|format(indicators.last_price) }}
                    </div>
                    {% if indicators.change_pct >= 0 %}
                    <div class="change-positive">â–² {{ '%.2f'|format(indicators.change_pct) }}%</div>
                    {% else %}
                    <div class="change-negative">â–¼ {{ '%.2f'|format(indicators.change_pct) }}%</div>
                    {% endif %}
                </div>
                {% endif %}
                <canvas id="priceChart"></canvas>
            </div>
        </div>

        <!-- AI å»ºè­° -->
        {% if ai_advice %}
        <div class="card ai-card">
            <div class="card-header d-flex align-items-center">
                <div class="card-title mb-0">ğŸ¤– AI åˆ†æå»ºè­°</div>
            </div>
            <div class="card-body ai-text">

                {% if ai_summary %}
                <div class="ai-summary mb-2">
                    <span class="ai-summary-label">âš¡ ä¸€å¥è©±æŠ€è¡“ç¸½è©•ï¼š</span>
                    <span class="ai-summary-text">{{ ai_summary }}</span>
                </div>
                {% endif %}

                <div>
                    {{ ai_advice }}
                </div>

                <div class="ai-disclaimer mt-2 text-muted" style="font-size:0.8rem;">
                    âš ï¸ ä»¥ä¸Šåˆ†æåªä¾›åƒè€ƒï¼Œä¸¦ä¸æ§‹æˆä»»ä½•è²·è³£å»ºè­°æˆ–ä¿è­‰ã€‚
                    æŠ•è³‡æ¶‰åŠé¢¨éšªï¼Œè«‹æ ¹æ“šè‡ªå·±é¢¨éšªæ‰¿å—èƒ½åŠ›åŠå¯¦éš›æƒ…æ³ç¨ç«‹åˆ¤æ–·ã€‚
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Chart.js åˆå§‹åŒ– -->
    <script>
        const labels = {{ chart_labels|tojson|default('[]') }};
        const prices = {{ chart_prices|tojson|default('[]') }};

        const ctx = document.getElementById("priceChart").getContext("2d");

        const chart = new Chart(ctx, {
            type: "line",
            data: {
                labels: labels,
                datasets: [
                    {
                        label: "æ”¶ç›¤åƒ¹",
                        data: prices,
                        tension: 0.25,
                        borderWidth: 2,
                        pointRadius: 0,
                        borderColor: "#38bdf8",
                        fill: false,
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        ticks: {
                            color: "#9ca3af",
                            maxRotation: 0,
                            minRotation: 0,
                            autoSkip: true,
                            maxTicksLimit: 10,
                        },
                        grid: {
                            color: "#1f2933",
                        },
                    },
                    y: {
                        ticks: {
                            color: "#9ca3af",
                        },
                        grid: {
                            color: "#111827",
                        },
                    },
                },
                plugins: {
                    legend: {
                        display: false,
                    },
                    tooltip: {
                        mode: "index",
                        intersect: false,
                        backgroundColor: "rgba(15, 23, 42, 0.95)",
                        titleColor: "#e5e7eb",
                        bodyColor: "#e5e7eb",
                        borderColor: "#4b5563",
                        borderWidth: 1,
                        padding: 10,
                        callbacks: {
                            label: (ctx) => {
                                const v = ctx.parsed.y;
                                return " æ”¶ç›¤åƒ¹: " + v.toFixed(2);
                            },
                        },
                    },
                },
                interaction: {
                    mode: "index",
                    intersect: false,
                },
            },
        });
    </script>
</body>
</html>